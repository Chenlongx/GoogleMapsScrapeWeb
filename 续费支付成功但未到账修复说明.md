# 续费支付成功但未到账问题修复说明

## 🐛 问题描述

**现象：**
- ✅ 二维码可以正常扫描
- ✅ 支付宝可以正常支付
- ❌ 支付成功后账号没有续费
- ❌ QT 对话框没有检测到支付成功（一直显示"等待支付"）

**日志显示：**
```
QT 控制台:
✅ [调试] 支付URL长度: 46
✅ [调试] 二维码显示成功
✅ 已启动支付状态检查 (订单ID: grm-xxx)

Netlify 日志:
✅ 开始生成支付二维码: 订单ID=grm-xxx, 金额=¥29.90
✅ 支付二维码生成成功: https://qr.alipay.com/bax08492u3gbfap3u0nx305c
```

---

## 🔍 问题根源

### 1. **数据库表不一致**

| 文件 | 使用的表 | 字段名 | 问题 |
|------|---------|--------|------|
| `createRenewalOrder.js` | `orders` | `out_trade_no` | ✅ 正确（订单创建） |
| `checkPaymentStatus.js` | `renewal_orders` | `order_id` | ❌ 错误（查询失败） |
| `alipayCallback.js` | `renewal_orders` | `order_id` | ❌ 错误（回调失败） |

**结果：** 订单存在 `orders` 表，但 `checkPaymentStatus` 去 `renewal_orders` 表查询，永远查不到！

### 2. **支付回调 URL 错误**

```javascript
// ❌ 旧代码（错误）
notify_url: 'https://mediamingle.cn/.netlify/functions/alipayCallback'
// alipayCallback.js 查询 renewal_orders 表，找不到订单

// ✅ 新代码（正确）
notify_url: 'https://mediamingle.cn/.netlify/functions/alipay-notify'
// alipay-notify.js 会调用 business-logic.js，正确处理续费
```

### 3. **续费逻辑路径**

**现有的正确路径：**
```
支付宝支付成功
  ↓
alipay-notify.js（接收回调）
  ↓
business-logic.js（处理业务逻辑）
  ↓
1. 更新 orders 表状态为 COMPLETED
  ↓
2. 查询 product_id（如 gmaps_renewal_monthly）
  ↓
3. 解析续费时长（1/3/12 个月）
  ↓
4. 更新 user_accounts 表的 expiry_at
  ↓
✅ 续费成功
```

**错误的路径（旧代码）：**
```
支付宝支付成功
  ↓
alipayCallback.js（接收回调）
  ↓
查询 renewal_orders 表 ❌ 找不到订单
  ↓
❌ 流程中断，续费失败
```

---

## ✅ 修复方案

### 修复 1：`checkPaymentStatus.js` - 使用正确的表和字段

```javascript
// ❌ 旧代码
const { data: orderData } = await supabase
  .from('renewal_orders')  // 错误的表
  .select('*')
  .eq('order_id', orderId)  // 错误的字段
  .single();

// ✅ 新代码
const { data: orderData } = await supabase
  .from('orders')  // ✅ 正确的表
  .select('*')
  .eq('out_trade_no', orderId)  // ✅ 正确的字段
  .single();

// ✅ 检查状态（兼容 COMPLETED 和 SUCCESS）
if (orderData.status === 'COMPLETED' || orderData.status === 'SUCCESS') {
  // 从 product_id 提取续费类型
  let renewalType = 'monthly';
  if (orderData.product_id.includes('quarterly')) renewalType = 'quarterly';
  else if (orderData.product_id.includes('yearly')) renewalType = 'yearly';
  
  // 查询用户的新到期时间
  const { data: userData } = await supabase
    .from('user_accounts')
    .select('expiry_at')
    .eq('account', orderData.customer_email)
    .single();
  
  return {
    success: true,
    paid: true,
    renewalType: renewalType,
    newExpiryDate: userData?.expiry_at
  };
}
```

### 修复 2：`createRenewalOrder.js` - 使用正确的回调 URL

```javascript
// ❌ 旧代码
notify_url: 'https://mediamingle.cn/.netlify/functions/alipayCallback'

// ✅ 新代码
notify_url: 'https://mediamingle.cn/.netlify/functions/alipay-notify'
```

---

## 📊 修复前后对比

### 修复前

```
用户扫码支付 → 支付成功
  ↓
支付宝通知 alipayCallback
  ↓
查询 renewal_orders 表 ❌ 找不到订单
  ↓
QT 应用轮询 checkPaymentStatus
  ↓
查询 renewal_orders 表 ❌ 找不到订单
  ↓
❌ 一直显示"等待支付"，账号未续费
```

### 修复后

```
用户扫码支付 → 支付成功
  ↓
支付宝通知 alipay-notify
  ↓
business-logic.js 处理续费
  ↓
1. 更新 orders 表状态为 COMPLETED ✅
2. 更新 user_accounts 表的 expiry_at ✅
  ↓
QT 应用轮询 checkPaymentStatus
  ↓
查询 orders 表 ✅ 找到订单
  ↓
✅ 检测到支付成功，显示"🎉 支付成功！"
✅ 账号到期时间自动更新
```

---

## 🚀 部署步骤

### 1. 提交修改

```bash
cd D:\GoogleMapsScrapeWeb
git add netlify/functions/createRenewalOrder.js
git add netlify/functions/checkPaymentStatus.js
git commit -m "fix: 修复续费支付成功但未到账问题"
git push origin main
```

### 2. 等待 Netlify 部署

- 登录 [Netlify 控制台](https://app.netlify.com)
- 等待部署完成（约 1-3 分钟）
- 查看部署日志确认成功

### 3. 测试续费流程

#### 步骤 1：生成二维码

1. 打开 QT 应用
2. 菜单栏 → **续费**
3. 选择**月付（¥29.90）**
4. 点击**生成支付二维码**
5. 查看控制台输出：
   ```
   ✅ [调试] 支付URL长度: 46
   ✅ [调试] 二维码显示成功
   ✅ 已启动支付状态检查
   ```

#### 步骤 2：扫码支付

1. 用支付宝扫描二维码
2. 确认支付金额：¥29.90
3. 完成支付

#### 步骤 3：验证支付成功

**QT 应用应该显示：**
```
🎉 支付成功！

续费类型: 月付
新到期时间: 2025-11-19

感谢您的支持！
```

**主界面顶部应该更新：**
```
授权剩余: 31 天  # 或相应的天数
```

#### 步骤 4：验证数据库

登录 Supabase 控制台，检查：

**`orders` 表：**
```sql
SELECT * FROM orders WHERE out_trade_no LIKE 'grm-%' ORDER BY created_at DESC LIMIT 1;
```
应该看到：
- `status` = `COMPLETED`
- `product_id` = `gmaps_renewal_monthly`
- `customer_email` = 您的账号

**`user_accounts` 表：**
```sql
SELECT account, expiry_at FROM user_accounts WHERE account = '您的账号';
```
应该看到：
- `expiry_at` 已更新为新的到期时间（当前时间 + 1个月）

---

## 🔍 如何验证修复是否生效

### 方法 1：查看 Netlify 函数日志

#### checkPaymentStatus 日志

```bash
netlify functions:log checkPaymentStatus
```

**修复前：**
```
⚠️ 订单不存在: 未找到  # 永远找不到
```

**修复后：**
```
🔍 查询订单状态: orderId=grm-xxx
✅ 找到订单: status=COMPLETED, product_id=gmaps_renewal_monthly
✅ 支付已完成: renewalType=monthly, newExpiry=2025-11-19T10:53:00+00:00
```

#### alipay-notify 日志

```bash
netlify functions:log alipay-notify
```

应该看到：
```
✅ 支付回调成功
✅ 订单状态已更新为 COMPLETED
✅ 用户到期时间已更新
```

### 方法 2：查看 QT 控制台输出

**修复前：**
```
⏳ 正在检查支付状态...
⏳ 正在检查支付状态...
⏳ 正在检查支付状态...
（一直循环，直到超时）
```

**修复后：**
```
⏳ 正在检查支付状态...
✅ 检测到支付成功！
🎉 支付成功！续费类型: 月付, 新到期时间: 2025-11-19
```

### 方法 3：检查主界面到期显示

**修复前：**
```
授权状态: 已过期
```

**修复后：**
```
授权剩余: 31 天
```

---

## 📝 相关文件

| 文件 | 修改内容 |
|------|---------|
| `netlify/functions/createRenewalOrder.js` | 将回调 URL 从 `alipayCallback` 改为 `alipay-notify` |
| `netlify/functions/checkPaymentStatus.js` | 将查询表从 `renewal_orders` 改为 `orders`，字段从 `order_id` 改为 `out_trade_no` |
| `续费支付成功但未到账修复说明.md` | 本文档，详细说明问题和修复方案 |

---

## ❓ 常见问题

### Q1: 为什么不修复 alipayCallback.js？
A: 因为现有的 `alipay-notify.js` + `business-logic.js` 已经能正确处理续费逻辑，不需要重复造轮子。`alipayCallback.js` 可以删除或保留备用。

### Q2: 支付成功后多久能检测到？
A: QT 应用每 2 秒轮询一次，最多 5 分钟超时。正常情况下，支付成功后 2-10 秒内就能检测到。

### Q3: 如果支付成功但 QT 应用超时怎么办？
A: 可以重新打开续费对话框，系统会自动检测到已支付的订单并更新到期时间。或者直接重启应用，主界面会显示最新的到期状态。

### Q4: 这次修复会影响网页版续费吗？
A: 不会。网页版一直使用正确的流程（`payment.js` → `alipay-notify` → `business-logic.js`），这次修复只是让 QT 应用的续费流程与网页版保持一致。

---

## 💡 技术要点

### 订单状态流转

```
PENDING（待支付）
  ↓ 支付宝通知
COMPLETED（已完成）
  ↓ business-logic.js 处理
SUCCESS（处理成功，可选）
```

### 续费时长计算

```javascript
// 从 product_id 提取续费类型
const renewalType = 
  product_id.includes('quarterly') ? 'quarterly' :
  product_id.includes('yearly') ? 'yearly' :
  'monthly';

// 计算新的到期时间
const months = {
  monthly: 1,
  quarterly: 3,
  yearly: 12
}[renewalType];

newExpiryAt = currentExpiryAt + (months * 30 days);
```

---

**最后更新：** 2025-10-19  
**版本：** v3.0  
**状态：** ✅ 已修复，待部署测试

