# ç»­è´¹æ”¯ä»˜æˆåŠŸä½†æœªåˆ°è´¦é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡ï¼š**
- âœ… äºŒç»´ç å¯ä»¥æ­£å¸¸æ‰«æ
- âœ… æ”¯ä»˜å®å¯ä»¥æ­£å¸¸æ”¯ä»˜
- âŒ æ”¯ä»˜æˆåŠŸåè´¦å·æ²¡æœ‰ç»­è´¹
- âŒ QT å¯¹è¯æ¡†æ²¡æœ‰æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸï¼ˆä¸€ç›´æ˜¾ç¤º"ç­‰å¾…æ”¯ä»˜"ï¼‰

**æ—¥å¿—æ˜¾ç¤ºï¼š**
```
QT æ§åˆ¶å°:
âœ… [è°ƒè¯•] æ”¯ä»˜URLé•¿åº¦: 46
âœ… [è°ƒè¯•] äºŒç»´ç æ˜¾ç¤ºæˆåŠŸ
âœ… å·²å¯åŠ¨æ”¯ä»˜çŠ¶æ€æ£€æŸ¥ (è®¢å•ID: grm-xxx)

Netlify æ—¥å¿—:
âœ… å¼€å§‹ç”Ÿæˆæ”¯ä»˜äºŒç»´ç : è®¢å•ID=grm-xxx, é‡‘é¢=Â¥29.90
âœ… æ”¯ä»˜äºŒç»´ç ç”ŸæˆæˆåŠŸ: https://qr.alipay.com/bax08492u3gbfap3u0nx305c
```

---

## ğŸ” é—®é¢˜æ ¹æº

### 1. **æ•°æ®åº“è¡¨ä¸ä¸€è‡´**

| æ–‡ä»¶ | ä½¿ç”¨çš„è¡¨ | å­—æ®µå | é—®é¢˜ |
|------|---------|--------|------|
| `createRenewalOrder.js` | `orders` | `out_trade_no` | âœ… æ­£ç¡®ï¼ˆè®¢å•åˆ›å»ºï¼‰ |
| `checkPaymentStatus.js` | `renewal_orders` | `order_id` | âŒ é”™è¯¯ï¼ˆæŸ¥è¯¢å¤±è´¥ï¼‰ |
| `alipayCallback.js` | `renewal_orders` | `order_id` | âŒ é”™è¯¯ï¼ˆå›è°ƒå¤±è´¥ï¼‰ |

**ç»“æœï¼š** è®¢å•å­˜åœ¨ `orders` è¡¨ï¼Œä½† `checkPaymentStatus` å» `renewal_orders` è¡¨æŸ¥è¯¢ï¼Œæ°¸è¿œæŸ¥ä¸åˆ°ï¼

### 2. **æ”¯ä»˜å›è°ƒ URL é”™è¯¯**

```javascript
// âŒ æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
notify_url: 'https://mediamingle.cn/.netlify/functions/alipayCallback'
// alipayCallback.js æŸ¥è¯¢ renewal_orders è¡¨ï¼Œæ‰¾ä¸åˆ°è®¢å•

// âœ… æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
notify_url: 'https://mediamingle.cn/.netlify/functions/alipay-notify'
// alipay-notify.js ä¼šè°ƒç”¨ business-logic.jsï¼Œæ­£ç¡®å¤„ç†ç»­è´¹
```

### 3. **ç»­è´¹é€»è¾‘è·¯å¾„**

**ç°æœ‰çš„æ­£ç¡®è·¯å¾„ï¼š**
```
æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸ
  â†“
alipay-notify.jsï¼ˆæ¥æ”¶å›è°ƒï¼‰
  â†“
business-logic.jsï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰
  â†“
1. æ›´æ–° orders è¡¨çŠ¶æ€ä¸º COMPLETED
  â†“
2. æŸ¥è¯¢ product_idï¼ˆå¦‚ gmaps_renewal_monthlyï¼‰
  â†“
3. è§£æç»­è´¹æ—¶é•¿ï¼ˆ1/3/12 ä¸ªæœˆï¼‰
  â†“
4. æ›´æ–° user_accounts è¡¨çš„ expiry_at
  â†“
âœ… ç»­è´¹æˆåŠŸ
```

**é”™è¯¯çš„è·¯å¾„ï¼ˆæ—§ä»£ç ï¼‰ï¼š**
```
æ”¯ä»˜å®æ”¯ä»˜æˆåŠŸ
  â†“
alipayCallback.jsï¼ˆæ¥æ”¶å›è°ƒï¼‰
  â†“
æŸ¥è¯¢ renewal_orders è¡¨ âŒ æ‰¾ä¸åˆ°è®¢å•
  â†“
âŒ æµç¨‹ä¸­æ–­ï¼Œç»­è´¹å¤±è´¥
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼š`checkPaymentStatus.js` - ä½¿ç”¨æ­£ç¡®çš„è¡¨å’Œå­—æ®µ

```javascript
// âŒ æ—§ä»£ç 
const { data: orderData } = await supabase
  .from('renewal_orders')  // é”™è¯¯çš„è¡¨
  .select('*')
  .eq('order_id', orderId)  // é”™è¯¯çš„å­—æ®µ
  .single();

// âœ… æ–°ä»£ç 
const { data: orderData } = await supabase
  .from('orders')  // âœ… æ­£ç¡®çš„è¡¨
  .select('*')
  .eq('out_trade_no', orderId)  // âœ… æ­£ç¡®çš„å­—æ®µ
  .single();

// âœ… æ£€æŸ¥çŠ¶æ€ï¼ˆå…¼å®¹ COMPLETED å’Œ SUCCESSï¼‰
if (orderData.status === 'COMPLETED' || orderData.status === 'SUCCESS') {
  // ä» product_id æå–ç»­è´¹ç±»å‹
  let renewalType = 'monthly';
  if (orderData.product_id.includes('quarterly')) renewalType = 'quarterly';
  else if (orderData.product_id.includes('yearly')) renewalType = 'yearly';
  
  // æŸ¥è¯¢ç”¨æˆ·çš„æ–°åˆ°æœŸæ—¶é—´
  const { data: userData } = await supabase
    .from('user_accounts')
    .select('expiry_at')
    .eq('account', orderData.customer_email)
    .single();
  
  return {
    success: true,
    paid: true,
    renewalType: renewalType,
    newExpiryDate: userData?.expiry_at
  };
}
```

### ä¿®å¤ 2ï¼š`createRenewalOrder.js` - ä½¿ç”¨æ­£ç¡®çš„å›è°ƒ URL

```javascript
// âŒ æ—§ä»£ç 
notify_url: 'https://mediamingle.cn/.netlify/functions/alipayCallback'

// âœ… æ–°ä»£ç 
notify_url: 'https://mediamingle.cn/.netlify/functions/alipay-notify'
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

```
ç”¨æˆ·æ‰«ç æ”¯ä»˜ â†’ æ”¯ä»˜æˆåŠŸ
  â†“
æ”¯ä»˜å®é€šçŸ¥ alipayCallback
  â†“
æŸ¥è¯¢ renewal_orders è¡¨ âŒ æ‰¾ä¸åˆ°è®¢å•
  â†“
QT åº”ç”¨è½®è¯¢ checkPaymentStatus
  â†“
æŸ¥è¯¢ renewal_orders è¡¨ âŒ æ‰¾ä¸åˆ°è®¢å•
  â†“
âŒ ä¸€ç›´æ˜¾ç¤º"ç­‰å¾…æ”¯ä»˜"ï¼Œè´¦å·æœªç»­è´¹
```

### ä¿®å¤å

```
ç”¨æˆ·æ‰«ç æ”¯ä»˜ â†’ æ”¯ä»˜æˆåŠŸ
  â†“
æ”¯ä»˜å®é€šçŸ¥ alipay-notify
  â†“
business-logic.js å¤„ç†ç»­è´¹
  â†“
1. æ›´æ–° orders è¡¨çŠ¶æ€ä¸º COMPLETED âœ…
2. æ›´æ–° user_accounts è¡¨çš„ expiry_at âœ…
  â†“
QT åº”ç”¨è½®è¯¢ checkPaymentStatus
  â†“
æŸ¥è¯¢ orders è¡¨ âœ… æ‰¾åˆ°è®¢å•
  â†“
âœ… æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸï¼Œæ˜¾ç¤º"ğŸ‰ æ”¯ä»˜æˆåŠŸï¼"
âœ… è´¦å·åˆ°æœŸæ—¶é—´è‡ªåŠ¨æ›´æ–°
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æäº¤ä¿®æ”¹

```bash
cd D:\GoogleMapsScrapeWeb
git add netlify/functions/createRenewalOrder.js
git add netlify/functions/checkPaymentStatus.js
git commit -m "fix: ä¿®å¤ç»­è´¹æ”¯ä»˜æˆåŠŸä½†æœªåˆ°è´¦é—®é¢˜"
git push origin main
```

### 2. ç­‰å¾… Netlify éƒ¨ç½²

- ç™»å½• [Netlify æ§åˆ¶å°](https://app.netlify.com)
- ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦ 1-3 åˆ†é’Ÿï¼‰
- æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—ç¡®è®¤æˆåŠŸ

### 3. æµ‹è¯•ç»­è´¹æµç¨‹

#### æ­¥éª¤ 1ï¼šç”ŸæˆäºŒç»´ç 

1. æ‰“å¼€ QT åº”ç”¨
2. èœå•æ  â†’ **ç»­è´¹**
3. é€‰æ‹©**æœˆä»˜ï¼ˆÂ¥29.90ï¼‰**
4. ç‚¹å‡»**ç”Ÿæˆæ”¯ä»˜äºŒç»´ç **
5. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š
   ```
   âœ… [è°ƒè¯•] æ”¯ä»˜URLé•¿åº¦: 46
   âœ… [è°ƒè¯•] äºŒç»´ç æ˜¾ç¤ºæˆåŠŸ
   âœ… å·²å¯åŠ¨æ”¯ä»˜çŠ¶æ€æ£€æŸ¥
   ```

#### æ­¥éª¤ 2ï¼šæ‰«ç æ”¯ä»˜

1. ç”¨æ”¯ä»˜å®æ‰«æäºŒç»´ç 
2. ç¡®è®¤æ”¯ä»˜é‡‘é¢ï¼šÂ¥29.90
3. å®Œæˆæ”¯ä»˜

#### æ­¥éª¤ 3ï¼šéªŒè¯æ”¯ä»˜æˆåŠŸ

**QT åº”ç”¨åº”è¯¥æ˜¾ç¤ºï¼š**
```
ğŸ‰ æ”¯ä»˜æˆåŠŸï¼

ç»­è´¹ç±»å‹: æœˆä»˜
æ–°åˆ°æœŸæ—¶é—´: 2025-11-19

æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼
```

**ä¸»ç•Œé¢é¡¶éƒ¨åº”è¯¥æ›´æ–°ï¼š**
```
æˆæƒå‰©ä½™: 31 å¤©  # æˆ–ç›¸åº”çš„å¤©æ•°
```

#### æ­¥éª¤ 4ï¼šéªŒè¯æ•°æ®åº“

ç™»å½• Supabase æ§åˆ¶å°ï¼Œæ£€æŸ¥ï¼š

**`orders` è¡¨ï¼š**
```sql
SELECT * FROM orders WHERE out_trade_no LIKE 'grm-%' ORDER BY created_at DESC LIMIT 1;
```
åº”è¯¥çœ‹åˆ°ï¼š
- `status` = `COMPLETED`
- `product_id` = `gmaps_renewal_monthly`
- `customer_email` = æ‚¨çš„è´¦å·

**`user_accounts` è¡¨ï¼š**
```sql
SELECT account, expiry_at FROM user_accounts WHERE account = 'æ‚¨çš„è´¦å·';
```
åº”è¯¥çœ‹åˆ°ï¼š
- `expiry_at` å·²æ›´æ–°ä¸ºæ–°çš„åˆ°æœŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ + 1ä¸ªæœˆï¼‰

---

## ğŸ” å¦‚ä½•éªŒè¯ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆ

### æ–¹æ³• 1ï¼šæŸ¥çœ‹ Netlify å‡½æ•°æ—¥å¿—

#### checkPaymentStatus æ—¥å¿—

```bash
netlify functions:log checkPaymentStatus
```

**ä¿®å¤å‰ï¼š**
```
âš ï¸ è®¢å•ä¸å­˜åœ¨: æœªæ‰¾åˆ°  # æ°¸è¿œæ‰¾ä¸åˆ°
```

**ä¿®å¤åï¼š**
```
ğŸ” æŸ¥è¯¢è®¢å•çŠ¶æ€: orderId=grm-xxx
âœ… æ‰¾åˆ°è®¢å•: status=COMPLETED, product_id=gmaps_renewal_monthly
âœ… æ”¯ä»˜å·²å®Œæˆ: renewalType=monthly, newExpiry=2025-11-19T10:53:00+00:00
```

#### alipay-notify æ—¥å¿—

```bash
netlify functions:log alipay-notify
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… æ”¯ä»˜å›è°ƒæˆåŠŸ
âœ… è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º COMPLETED
âœ… ç”¨æˆ·åˆ°æœŸæ—¶é—´å·²æ›´æ–°
```

### æ–¹æ³• 2ï¼šæŸ¥çœ‹ QT æ§åˆ¶å°è¾“å‡º

**ä¿®å¤å‰ï¼š**
```
â³ æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...
â³ æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...
â³ æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...
ï¼ˆä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°è¶…æ—¶ï¼‰
```

**ä¿®å¤åï¼š**
```
â³ æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...
âœ… æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸï¼
ğŸ‰ æ”¯ä»˜æˆåŠŸï¼ç»­è´¹ç±»å‹: æœˆä»˜, æ–°åˆ°æœŸæ—¶é—´: 2025-11-19
```

### æ–¹æ³• 3ï¼šæ£€æŸ¥ä¸»ç•Œé¢åˆ°æœŸæ˜¾ç¤º

**ä¿®å¤å‰ï¼š**
```
æˆæƒçŠ¶æ€: å·²è¿‡æœŸ
```

**ä¿®å¤åï¼š**
```
æˆæƒå‰©ä½™: 31 å¤©
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `netlify/functions/createRenewalOrder.js` | å°†å›è°ƒ URL ä» `alipayCallback` æ”¹ä¸º `alipay-notify` |
| `netlify/functions/checkPaymentStatus.js` | å°†æŸ¥è¯¢è¡¨ä» `renewal_orders` æ”¹ä¸º `orders`ï¼Œå­—æ®µä» `order_id` æ”¹ä¸º `out_trade_no` |
| `ç»­è´¹æ”¯ä»˜æˆåŠŸä½†æœªåˆ°è´¦ä¿®å¤è¯´æ˜.md` | æœ¬æ–‡æ¡£ï¼Œè¯¦ç»†è¯´æ˜é—®é¢˜å’Œä¿®å¤æ–¹æ¡ˆ |

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ä¿®å¤ alipayCallback.jsï¼Ÿ
A: å› ä¸ºç°æœ‰çš„ `alipay-notify.js` + `business-logic.js` å·²ç»èƒ½æ­£ç¡®å¤„ç†ç»­è´¹é€»è¾‘ï¼Œä¸éœ€è¦é‡å¤é€ è½®å­ã€‚`alipayCallback.js` å¯ä»¥åˆ é™¤æˆ–ä¿ç•™å¤‡ç”¨ã€‚

### Q2: æ”¯ä»˜æˆåŠŸåå¤šä¹…èƒ½æ£€æµ‹åˆ°ï¼Ÿ
A: QT åº”ç”¨æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡ï¼Œæœ€å¤š 5 åˆ†é’Ÿè¶…æ—¶ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ”¯ä»˜æˆåŠŸå 2-10 ç§’å†…å°±èƒ½æ£€æµ‹åˆ°ã€‚

### Q3: å¦‚æœæ”¯ä»˜æˆåŠŸä½† QT åº”ç”¨è¶…æ—¶æ€ä¹ˆåŠï¼Ÿ
A: å¯ä»¥é‡æ–°æ‰“å¼€ç»­è´¹å¯¹è¯æ¡†ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹åˆ°å·²æ”¯ä»˜çš„è®¢å•å¹¶æ›´æ–°åˆ°æœŸæ—¶é—´ã€‚æˆ–è€…ç›´æ¥é‡å¯åº”ç”¨ï¼Œä¸»ç•Œé¢ä¼šæ˜¾ç¤ºæœ€æ–°çš„åˆ°æœŸçŠ¶æ€ã€‚

### Q4: è¿™æ¬¡ä¿®å¤ä¼šå½±å“ç½‘é¡µç‰ˆç»­è´¹å—ï¼Ÿ
A: ä¸ä¼šã€‚ç½‘é¡µç‰ˆä¸€ç›´ä½¿ç”¨æ­£ç¡®çš„æµç¨‹ï¼ˆ`payment.js` â†’ `alipay-notify` â†’ `business-logic.js`ï¼‰ï¼Œè¿™æ¬¡ä¿®å¤åªæ˜¯è®© QT åº”ç”¨çš„ç»­è´¹æµç¨‹ä¸ç½‘é¡µç‰ˆä¿æŒä¸€è‡´ã€‚

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### è®¢å•çŠ¶æ€æµè½¬

```
PENDINGï¼ˆå¾…æ”¯ä»˜ï¼‰
  â†“ æ”¯ä»˜å®é€šçŸ¥
COMPLETEDï¼ˆå·²å®Œæˆï¼‰
  â†“ business-logic.js å¤„ç†
SUCCESSï¼ˆå¤„ç†æˆåŠŸï¼Œå¯é€‰ï¼‰
```

### ç»­è´¹æ—¶é•¿è®¡ç®—

```javascript
// ä» product_id æå–ç»­è´¹ç±»å‹
const renewalType = 
  product_id.includes('quarterly') ? 'quarterly' :
  product_id.includes('yearly') ? 'yearly' :
  'monthly';

// è®¡ç®—æ–°çš„åˆ°æœŸæ—¶é—´
const months = {
  monthly: 1,
  quarterly: 3,
  yearly: 12
}[renewalType];

newExpiryAt = currentExpiryAt + (months * 30 days);
```

---

**æœ€åæ›´æ–°ï¼š** 2025-10-19  
**ç‰ˆæœ¬ï¼š** v3.0  
**çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤ï¼Œå¾…éƒ¨ç½²æµ‹è¯•

