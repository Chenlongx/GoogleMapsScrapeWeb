# 代理佣金分配修复说明

## 问题描述

客户付款之后，代理端产品转化数和产品佣金没有变化，代理仪表板显示的数据没有更新。

**问题现象**：
- 客户支付成功，收到激活码邮件
- 代理仪表板中的产品转化数没有增加
- 代理仪表板中的产品佣金没有增加
- 代理的总佣金和可用余额没有更新

## 错误分析

### 错误原因

**问题分析**：
1. **SQL语法问题**：使用了`supabase.sql`语法，可能不被支持
2. **数据表不匹配**：代理仪表板查询`commission_records`表，但业务逻辑创建的是`product_orders`表
3. **数据更新失败**：推广记录和代理余额更新可能失败
4. **错误处理不足**：缺少详细的错误日志

### 根本原因

**business-logic.js问题**：
- 使用了`supabase.sql`语法更新数据
- 没有先获取当前值再计算新值
- 错误处理不够详细

**getAgentDashboard.js问题**：
- 查询了错误的数据表（`commission_records`而不是`product_orders`）
- 数据源不匹配导致显示错误

## 修复方案

### 修复1：business-logic.js佣金更新逻辑

#### 修复前
```javascript
// 更新推广记录的转化次数和佣金
if (referralCode) {
    const { error: updatePromotionError } = await supabase
        .from('product_promotions')
        .update({ 
            conversions_count: supabase.sql`conversions_count + 1`,  // ❌ 不支持的语法
            total_commission: supabase.sql`total_commission + ${commissionAmount}`,  // ❌ 不支持的语法
            updated_at: new Date().toISOString()
        })
        .eq('promotion_code', referralCode);
}

// 更新代理余额
const { error: updateBalanceError } = await supabase
    .from('agent_profiles')
    .update({ 
        total_commission: supabase.sql`total_commission + ${commissionAmount}`,  // ❌ 不支持的语法
        available_balance: supabase.sql`available_balance + ${commissionAmount}`,  // ❌ 不支持的语法
        updated_at: new Date().toISOString()
    })
    .eq('id', agentId);
```

#### 修复后
```javascript
// 更新推广记录的转化次数和佣金
if (referralCode) {
    // 先获取当前记录
    const { data: currentPromotion, error: fetchError } = await supabase
        .from('product_promotions')
        .select('conversions_count, total_commission')
        .eq('promotion_code', referralCode)
        .single();

    if (!fetchError && currentPromotion) {
        const newConversionsCount = (currentPromotion.conversions_count || 0) + 1;
        const newTotalCommission = (currentPromotion.total_commission || 0) + commissionAmount;

        const { error: updatePromotionError } = await supabase
            .from('product_promotions')
            .update({ 
                conversions_count: newConversionsCount,  // ✅ 正确的语法
                total_commission: newTotalCommission,  // ✅ 正确的语法
                updated_at: new Date().toISOString()
            })
            .eq('promotion_code', referralCode);

        if (updatePromotionError) {
            console.error('更新推广记录失败:', updatePromotionError);
        } else {
            console.log(`推广记录更新成功: 转化数+1, 佣金+${commissionAmount}`);
        }
    } else {
        console.error('获取推广记录失败:', fetchError);
    }
}

// 更新代理余额
// 先获取当前代理信息
const { data: currentAgent, error: fetchAgentError } = await supabase
    .from('agent_profiles')
    .select('total_commission, available_balance')
    .eq('id', agentId)
    .single();

if (!fetchAgentError && currentAgent) {
    const newTotalCommission = (currentAgent.total_commission || 0) + commissionAmount;
    const newAvailableBalance = (currentAgent.available_balance || 0) + commissionAmount;

    const { error: updateBalanceError } = await supabase
        .from('agent_profiles')
        .update({ 
            total_commission: newTotalCommission,  // ✅ 正确的语法
            available_balance: newAvailableBalance,  // ✅ 正确的语法
            updated_at: new Date().toISOString()
        })
        .eq('id', agentId);

    if (updateBalanceError) {
        console.error('更新代理余额失败:', updateBalanceError);
    } else {
        console.log(`代理 ${agentId} 获得佣金 ${commissionAmount} 元，总佣金: ${newTotalCommission}，可用余额: ${newAvailableBalance}`);
    }
} else {
    console.error('获取代理信息失败:', fetchAgentError);
}
```

### 修复2：getAgentDashboard.js数据源修正

#### 修复前
```javascript
// 4. 获取本月佣金统计
const { data: monthlyCommissions } = await supabase
  .from('commission_records')  // ❌ 错误的数据表
  .select('commission_amount')
  .eq('agent_id', agentProfile.id)
  .eq('status', 'paid')
  .gte('created_at', currentMonth.toISOString());

// 5. 获取待审核佣金
const { data: pendingCommissions } = await supabase
  .from('commission_records')  // ❌ 错误的数据表
  .select(`...`)
  .eq('agent_id', agentProfile.id)
  .eq('status', 'pending');
```

#### 修复后
```javascript
// 4. 获取本月佣金统计
const { data: monthlyCommissions } = await supabase
  .from('product_orders')  // ✅ 正确的数据表
  .select('commission_amount')
  .eq('agent_id', agentProfile.id)
  .eq('status', 'paid')
  .gte('created_at', currentMonth.toISOString());

// 5. 获取待审核佣金
const { data: pendingCommissions } = await supabase
  .from('product_orders')  // ✅ 正确的数据表
  .select(`...`)
  .eq('agent_id', agentProfile.id)
  .eq('status', 'pending');
```

## 修复逻辑

### 数据更新流程

```
修复前（错误流程）：
1. 创建product_orders记录 ✅
2. 使用supabase.sql更新推广记录 ❌ (语法错误)
3. 使用supabase.sql更新代理余额 ❌ (语法错误)
4. 仪表板查询commission_records ❌ (数据表错误)

修复后（正确流程）：
1. 创建product_orders记录 ✅
2. 获取当前推广记录 → 计算新值 → 更新推广记录 ✅
3. 获取当前代理信息 → 计算新值 → 更新代理余额 ✅
4. 仪表板查询product_orders ✅
```

### 佣金分配逻辑

```
1. 客户支付成功
2. 业务逻辑处理：
   ├─ 发送激活码邮件
   ├─ 创建product_orders记录
   ├─ 更新推广记录（转化数+1，佣金+金额）
   └─ 更新代理余额（总佣金+金额，可用余额+金额）
3. 代理仪表板显示：
   ├─ 从product_orders获取佣金数据
   ├─ 从product_promotions获取推广数据
   └─ 从agent_profiles获取余额数据
```

## 测试步骤

### 1. 部署修复

```bash
cd "D:/GoogleMapsScrapeWeb"
git add netlify/functions/business-logic.js
git commit -m "修复代理佣金分配逻辑 - SQL语法和数据表问题"
git push origin main

cd "c:/Users/A/Downloads/Google-Maps-Backend-master"
git add netlify/functions/getAgentDashboard.js
git commit -m "修复代理仪表板数据源 - 使用正确的数据表"
git push origin main
```

### 2. 测试支付流程

1. **访问推广链接**：
   ```
   https://mediamingle.cn/product.html?id=maps-scraper&ref=V9QGKNTF_google-maps_1759116221197_w73ba
   ```

2. **完成支付流程**：
   - 点击购买按钮
   - 填写邮箱信息
   - 完成支付宝支付

3. **验证佣金分配**：
   - 检查后端日志，确认佣金处理成功
   - 登录代理仪表板，检查数据更新

### 3. 检查后端日志

应该看到详细的佣金处理日志：
```
开始处理推广佣金: {outTradeNo: "gs-xxx", customerEmail: "xxx@example.com", productId: "gmaps_standard"}
找到订单信息: {...}
推广记录更新成功: 转化数+1, 佣金+51.00
代理 xxx 获得佣金 51.00 元，总佣金: 102.00，可用余额: 102.00
```

### 4. 验证代理仪表板

1. **登录代理仪表板**
2. **检查数据更新**：
   - 产品转化数应该增加
   - 产品佣金应该增加
   - 总佣金应该增加
   - 可用余额应该增加

## 预期结果

### 1. 佣金分配正常
- ✅ 推广记录转化数正确增加
- ✅ 推广记录佣金正确增加
- ✅ 代理总佣金正确增加
- ✅ 代理可用余额正确增加

### 2. 代理仪表板显示正确
- ✅ 产品转化数显示正确
- ✅ 产品佣金显示正确
- ✅ 总佣金显示正确
- ✅ 可用余额显示正确

### 3. 数据一致性
- ✅ 所有数据表数据一致
- ✅ 前端显示与后端数据一致
- ✅ 实时更新正常

## 技术要点

### 1. Supabase数据更新
- **避免SQL语法**：不使用`supabase.sql`语法
- **先查询后更新**：先获取当前值，再计算新值
- **错误处理**：详细的错误日志和异常处理

### 2. 数据表一致性
- **统一数据源**：所有相关功能使用相同的数据表
- **数据完整性**：确保数据更新的原子性
- **实时同步**：前端显示与后端数据实时同步

### 3. 佣金计算逻辑
- **准确计算**：基于订单金额和分佣比例
- **多级支持**：支持不同产品的不同分佣比例
- **余额管理**：正确管理代理的总佣金和可用余额

## 总结

通过修复代理佣金分配问题，我们：

1. ✅ **修复SQL语法错误**：使用正确的数据更新方式
2. ✅ **统一数据源**：代理仪表板使用正确的数据表
3. ✅ **完善错误处理**：添加详细的错误日志
4. ✅ **确保数据一致性**：所有相关功能数据同步

修复完成后，客户付款后代理端的产品转化数和产品佣金应该能够正确更新！
