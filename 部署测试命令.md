# 部署和测试命令

## 🚀 快速部署（模拟模式）

### 步骤1：切换目录
```bash
cd D:\GoogleMapsScrapeWeb
```

### 步骤2：检查修改的文件
```bash
# 查看修改的函数
dir netlify\functions\*.js
```

应该看到：
- ✅ `createRenewalOrder.js` - 已修复
- ✅ `checkPaymentStatus.js` - 已修复
- ✅ `alipayCallback.js` - 已修复

### 步骤3：部署到Netlify
```bash
# 如果尚未登录
netlify login

# 部署到生产环境
netlify deploy --prod
```

**按提示操作：**
1. 选择发布目录：`public` (或者按回车使用默认)
2. 等待部署完成
3. 看到成功消息和网站URL

---

## 🧪 测试命令

### 测试1：创建订单（模拟模式）
```bash
curl -X POST https://mediamingle.cn/.netlify/functions/createRenewalOrder \
  -H "Content-Type: application/json" \
  -d "{\"userId\":\"test_user\",\"username\":\"test@example.com\",\"renewalType\":\"monthly\",\"amount\":29.90,\"duration\":\"1个月\",\"productName\":\"谷歌地图商家爬虫-月付\"}"
```

**预期响应（模拟模式）：**
```json
{
  "success": true,
  "message": "订单创建成功（测试模式）",
  "orderId": "MOCK_1697720000000_abc123",
  "paymentUrl": "https://qr.alipay.com/baxMOCK_1697720000000_abc123",
  "mode": "mock",
  "note": "这是测试模式，请配置Supabase环境变量以使用真实订单系统"
}
```

**✅ 成功标志：**
- 返回JSON格式
- `success: true`
- 包含 `mode: "mock"`
- 没有500/502错误

---

### 测试2：检查支付状态（模拟模式）
```bash
curl -X POST https://mediamingle.cn/.netlify/functions/checkPaymentStatus \
  -H "Content-Type: application/json" \
  -d "{\"orderId\":\"MOCK_123\",\"userId\":\"test_user\"}"
```

**预期响应（模拟模式）：**
```json
{
  "success": true,
  "status": "pending",
  "message": "支付状态查询中（测试模式）",
  "mode": "mock",
  "note": "这是测试模式，请配置Supabase环境变量以使用真实订单系统"
}
```

---

### 测试3：支付回调（模拟模式）
```bash
curl -X POST https://mediamingle.cn/.netlify/functions/alipayCallback \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "out_trade_no=MOCK_123&trade_status=TRADE_SUCCESS"
```

**预期响应（模拟模式）：**
```
success
```

---

## 🎯 前端测试

### 步骤1：启动程序
```bash
cd D:\gogole_maps
python Maps_scraper.py
```

### 步骤2：打开续费对话框
1. 点击菜单：**帮助** → **续费服务**
2. 选择续费方案（月付/季付/年付）
3. 点击：**生成支付二维码**

### 步骤3：验证结果

**成功情况（模拟模式）：**
- ✅ 显示支付宝二维码
- ✅ 状态显示："✅ 请使用支付宝扫码支付"
- ✅ 二维码可以显示（虽然是模拟URL）
- ✅ 没有502错误

**注意事项：**
- ⚠️ 支付检测不会成功（因为是模拟订单）
- ⚠️ 扫码后不会真实支付
- ⚠️ 这只是UI测试

**如果需要网页续费：**
- 点击对话框底部的链接
- 或在错误时选择"打开网页续费"

---

## 📊 测试结果判断

### ✅ 成功标志
- [ ] 部署命令执行成功
- [ ] 测试1返回JSON（包含mode: "mock"）
- [ ] 测试2返回JSON（包含mode: "mock"）
- [ ] 测试3返回"success"
- [ ] 前端可以生成二维码
- [ ] 没有500/502错误

### ❌ 失败情况

#### 502 Bad Gateway
**原因：** 函数未正确部署
**解决：** 重新运行 `netlify deploy --prod`

#### 404 Not Found
**原因：** 函数路径错误
**解决：** 检查函数是否在 `netlify/functions/` 目录

#### supabaseKey is required
**原因：** 旧代码未更新
**解决：** 确认修改已保存，重新部署

---

## 🔄 更新流程

如果需要修改代码：

```bash
# 1. 修改代码
# 编辑 D:\GoogleMapsScrapeWeb\netlify\functions\*.js

# 2. 重新部署
cd D:\GoogleMapsScrapeWeb
netlify deploy --prod

# 3. 测试
curl https://mediamingle.cn/.netlify/functions/createRenewalOrder

# 4. 前端测试
cd D:\gogole_maps
python Maps_scraper.py
```

---

## 💡 常见问题

### Q1: 部署后还是502错误？
**A:** 等待1-2分钟让Netlify完全部署，然后再测试。

### Q2: 前端还是显示"服务器错误: 502"？
**A:** 
1. 确认后端已部署成功（用curl测试）
2. 清除前端缓存，重启程序
3. 检查网络连接

### Q3: 模拟模式的二维码能用吗？
**A:** 不能真实支付，但可以测试UI。要真实支付需要：
1. 配置Supabase环境变量
2. 配置支付宝参数
3. 或使用网页续费

### Q4: 如何切换到真实模式？
**A:** 
1. 在Netlify配置环境变量：
   - `SUPABASE_URL`
   - `SUPABASE_SERVICE_KEY`
2. 在Supabase创建数据库表
3. 重新部署

### Q5: 支付检测为什么一直pending？
**A:** 在模拟模式下，支付检测永远返回pending。这是正常的。

---

## 🎉 完成确认

部署成功的标志：

```bash
# 运行这个命令
curl https://mediamingle.cn/.netlify/functions/createRenewalOrder

# 如果看到这样的响应，说明部署成功：
{
  "success": false,
  "message": "Method Not Allowed"
}

# 或者（POST请求后）：
{
  "success": true,
  "mode": "mock",
  ...
}
```

**不应该看到：**
- ❌ 502 Bad Gateway
- ❌ 404 Not Found
- ❌ supabaseKey is required

---

## 📝 下一步

### 立即可用（模拟模式）✅
- [x] 修复代码
- [x] 部署到Netlify
- [x] 测试API
- [x] 测试前端
- [x] 用户可通过网页续费

### 长期优化（真实模式）⏳
- [ ] 配置Supabase环境变量
- [ ] 创建数据库表
- [ ] 配置支付宝参数（可选）
- [ ] 完整测试真实支付流程

---

**更新时间：** 2024-10-19  
**状态：** ✅ 代码已修复，支持模拟模式  
**下一步：** 部署并测试

