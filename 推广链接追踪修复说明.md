# 推广链接追踪修复说明

## 问题分析

根据用户提供的推广链接 `https://mediamingle.cn/product.html?id=maps-scraper&ref=V9QGKNTF_google-maps_1759116221197_w73ba`，发现推广链接追踪无法正常工作。

### 推广码格式分析

**推广码**：`V9QGKNTF_google-maps_1759116221197_w73ba`
**格式**：`AGENT_CODE_PRODUCT_TYPE_TIMESTAMP_RANDOM`

- `V9QGKNTF` - 代理代码
- `google-maps` - 产品类型  
- `1759116221197` - 时间戳
- `w73ba` - 随机字符串

## 发现的问题

### 1. 推广码解析逻辑问题

**文件**：`D:/GoogleMapsScrapeWeb/assets/js/referral-tracker.js`

**问题**：推广码解析时没有处理随机部分可能包含下划线的情况

**修复前**：
```javascript
if (parts.length >= 4) {
    this.referralData = {
        agentCode: parts[0],
        productType: parts[1],
        timestamp: parts[2],
        random: parts[3], // 只取第4个部分
        fullCode: refCode,
        source: 'url'
    };
}
```

**修复后**：
```javascript
if (parts.length >= 4) {
    this.referralData = {
        agentCode: parts[0],
        productType: parts[1],
        timestamp: parts[2],
        random: parts.slice(3).join('_'), // 处理可能包含下划线的随机部分
        fullCode: refCode,
        source: 'url'
    };
}
```

### 2. 产品页面未加载推广追踪器

**文件**：`D:/GoogleMapsScrapeWeb/product.html`

**问题**：product.html页面没有直接加载推广追踪器，依赖main.js的动态加载

**修复**：直接在product.html中加载推广追踪器
```html
<script src="./assets/js/main.js" defer></script>
<script src="./assets/js/referral-tracker.js" defer></script>
```

### 3. 调试信息不足

**问题**：推广码解析和追踪过程中缺少详细的调试信息

**修复**：添加详细的调试日志
```javascript
console.log('MediaMingle推广追踪器: 从URL获取推广码:', refCode);
console.log('MediaMingle推广追踪器: 推广码分割结果:', parts);
console.log('MediaMingle推广追踪器: 推广信息解析成功:', this.referralData);
```

## 修复内容

### 1. 增强推广码解析逻辑

**文件**：`D:/GoogleMapsScrapeWeb/assets/js/referral-tracker.js`

```javascript
parseReferralFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    
    console.log('MediaMingle推广追踪器: 从URL获取推广码:', refCode);
    
    if (refCode) {
        try {
            // 解析推广码: AGENT_CODE_PRODUCT_TYPE_TIMESTAMP_RANDOM
            const parts = refCode.split('_');
            console.log('MediaMingle推广追踪器: 推广码分割结果:', parts);
            
            if (parts.length >= 4) {
                this.referralData = {
                    agentCode: parts[0],
                    productType: parts[1],
                    timestamp: parts[2],
                    random: parts.slice(3).join('_'), // 处理可能包含下划线的随机部分
                    fullCode: refCode,
                    source: 'url'
                };

                // 存储到localStorage和Cookie
                this.storeReferralData();
                
                console.log('MediaMingle推广信息解析成功:', this.referralData);
                
                // 显示推广信息提示
                this.showReferralNotification();
            } else {
                console.error('MediaMingle推广追踪器: 推广码格式不正确，期望至少4个部分，实际:', parts.length);
            }
        } catch (error) {
            console.error('推广码解析失败:', error);
        }
    } else {
        console.log('MediaMingle推广追踪器: URL中没有推广码，尝试从存储中恢复');
        // 尝试从localStorage恢复推广信息
        this.loadStoredReferralData();
    }
}
```

### 2. 确保推广追踪器加载

**文件**：`D:/GoogleMapsScrapeWeb/product.html`

```html
<script src="./assets/js/main.js" defer></script>
<script src="./assets/js/referral-tracker.js" defer></script>
```

### 3. 创建测试页面

**文件**：`D:/GoogleMapsScrapeWeb/test-promotion-tracking.html`

创建了一个专门的测试页面，包含：
- 测试链接
- 推广信息显示
- 追踪器状态检查
- 控制台输出捕获
- 测试说明

## 测试步骤

### 1. 部署修复

```bash
cd "D:/GoogleMapsScrapeWeb"
git add assets/js/referral-tracker.js
git add product.html
git add test-promotion-tracking.html
git commit -m "修复推广链接追踪问题"
git push origin main
```

### 2. 测试推广链接追踪

1. **访问测试页面**：
   ```
   https://mediamingle.cn/test-promotion-tracking.html
   ```

2. **点击测试链接**：
   ```
   https://mediamingle.cn/product.html?id=maps-scraper&ref=V9QGKNTF_google-maps_1759116221197_w73ba
   ```

3. **检查浏览器控制台**：
   - 打开开发者工具（F12）
   - 查看Console标签页
   - 确认推广信息解析成功
   - 确认点击追踪API被调用

4. **验证追踪结果**：
   - 检查代理仪表板的推广点击量
   - 确认数据是否正确更新

### 3. 测试完整流程

1. **访问推广链接** → 触发点击追踪
2. **完成下单流程** → 触发转化追踪  
3. **检查代理仪表板** → 确认数据更新

## 预期结果

### 点击追踪成功
- 推广码正确解析
- 点击记录插入到`promotion_clicks`表
- `product_promotions`表的`clicks_count`增加1

### 转化追踪成功
- 订单信息包含推广码
- 转化记录插入到`product_orders`表
- `product_promotions`表的`conversions_count`增加1
- 代理余额更新

### 代理仪表板更新
- 推广点击量显示正确
- 产品转化数显示正确
- 产品佣金显示正确

## 排查方法

### 1. 推广码解析失败
- 检查浏览器控制台错误
- 验证推广码格式
- 确认URL参数正确

### 2. 点击追踪失败
- 检查API调用是否成功
- 验证数据库连接
- 查看Netlify Functions日志

### 3. 转化追踪失败
- 检查订单表数据
- 验证推广码匹配
- 确认佣金计算逻辑

## 数据库表结构

### promotion_clicks 表
```sql
CREATE TABLE IF NOT EXISTS promotion_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  promotion_code VARCHAR(100) NOT NULL,
  agent_id UUID REFERENCES agent_profiles(id),
  ip_address INET,
  user_agent TEXT,
  referrer TEXT,
  clicked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### product_promotions 表
```sql
CREATE TABLE IF NOT EXISTS product_promotions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agent_id UUID REFERENCES agent_profiles(id),
  product_type VARCHAR(50) NOT NULL,
  promotion_code VARCHAR(100) UNIQUE NOT NULL,
  commission_rate DECIMAL(5,2) NOT NULL,
  status VARCHAR(20) DEFAULT 'active',
  clicks_count INTEGER DEFAULT 0,
  conversions_count INTEGER DEFAULT 0,
  total_commission DECIMAL(10,2) DEFAULT 0.00,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 总结

通过这次修复，我们：

1. ✅ **修复推广码解析**：正确处理包含下划线的随机部分
2. ✅ **确保追踪器加载**：直接在product.html中加载推广追踪器
3. ✅ **增强调试信息**：添加详细的日志记录
4. ✅ **创建测试页面**：提供完整的测试和验证工具

修复完成后，推广链接追踪功能应该能够正常工作，代理仪表板的数据也会正确更新！