# âœ… ç¯å¢ƒå˜é‡åç§°ä¿®å¤è¯´æ˜

## ğŸ‰ å¥½æ¶ˆæ¯ï¼

ç¯å¢ƒå˜é‡å…¶å®å·²ç»é…ç½®äº†ï¼Œåªæ˜¯åç§°ä¸åŒï¼

### ç°æœ‰çš„ç¯å¢ƒå˜é‡
- âœ… `SUPABASE_URL` - å·²å­˜åœ¨
- âœ… `SUPABASE_SERVICE_ROLE_KEY` - å·²å­˜åœ¨ï¼ˆä¹‹å‰æ‰¾çš„æ˜¯ `SUPABASE_SERVICE_KEY`ï¼‰
- âœ… `SUPABASE_ANON_KEY` - å·²å­˜åœ¨ï¼ˆå¯ç”¨äºå‰ç«¯ï¼‰

---

## ğŸ”§ ä¿®å¤å†…å®¹

### ä¿®æ”¹äº†3ä¸ªNetlifyå‡½æ•°

æ‰€æœ‰å‡½æ•°ç°åœ¨ä¼šæŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾ç¯å¢ƒå˜é‡ï¼š

```javascript
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY ||  // â† ä¼˜å…ˆä½¿ç”¨è¿™ä¸ª
                     process.env.SUPABASE_SERVICE_KEY ||       // â† å…¼å®¹æ€§
                     process.env.SUPABASE_KEY;                 // â† å…œåº•
```

### ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `createRenewalOrder.js` - ä½¿ç”¨ `SUPABASE_SERVICE_ROLE_KEY`
2. âœ… `checkPaymentStatus.js` - ä½¿ç”¨ `SUPABASE_SERVICE_ROLE_KEY`
3. âœ… `alipayCallback.js` - ä½¿ç”¨ `SUPABASE_SERVICE_ROLE_KEY`

### æ–°å¢çš„æ—¥å¿—
```javascript
if (supabaseUrl && supabaseKey) {
  supabase = createClient(supabaseUrl, supabaseKey);
  console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');  // â† æ–°å¢æˆåŠŸæ—¥å¿—
}
```

---

## ğŸ“‹ ç¯å¢ƒå˜é‡è¯´æ˜

### SUPABASE_SERVICE_ROLE_KEYï¼ˆæœåŠ¡ç«¯ä½¿ç”¨ï¼‰âœ…
- **ç”¨é€”ï¼š** æœåŠ¡ç«¯APIå¯†é’¥ï¼Œæ‹¥æœ‰å®Œå…¨æƒé™
- **ä½¿ç”¨åœºæ™¯ï¼š** Netlifyå‡½æ•°ï¼ˆåç«¯ï¼‰
- **æƒé™ï¼š** å®Œå…¨æƒé™ï¼Œå¯ä»¥ç»•è¿‡RLSï¼ˆRow Level Securityï¼‰
- **å®‰å…¨æ€§ï¼š** åªèƒ½åœ¨æœåŠ¡ç«¯ä½¿ç”¨ï¼Œä¸èƒ½æš´éœ²ç»™å®¢æˆ·ç«¯

### SUPABASE_ANON_KEYï¼ˆå®¢æˆ·ç«¯ä½¿ç”¨ï¼‰
- **ç”¨é€”ï¼š** åŒ¿åAPIå¯†é’¥ï¼Œå—RLSé™åˆ¶
- **ä½¿ç”¨åœºæ™¯ï¼š** å‰ç«¯åº”ç”¨ã€ç§»åŠ¨åº”ç”¨
- **æƒé™ï¼š** å—é™æƒé™ï¼Œå¿…é¡»éµå®ˆRLSè§„åˆ™
- **å®‰å…¨æ€§ï¼š** å¯ä»¥å…¬å¼€ï¼Œå®‰å…¨æ€§ç”±RLSä¿è¯

### SUPABASE_URL
- **ç”¨é€”ï¼š** Supabaseé¡¹ç›®çš„APIç«¯ç‚¹
- **æ ¼å¼ï¼š** `https://xxxxx.supabase.co`
- **ä½¿ç”¨åœºæ™¯ï¼š** å‰ç«¯å’Œåç«¯éƒ½éœ€è¦

---

## ğŸš€ ç°åœ¨çš„çŠ¶æ€

### âœ… ç¯å¢ƒå˜é‡ - å·²é…ç½®
- [x] SUPABASE_URL
- [x] SUPABASE_SERVICE_ROLE_KEY
- [x] SUPABASE_ANON_KEY

### â³ æ•°æ®åº“è¡¨ - å¾…åˆ›å»º
- [ ] renewal_orders è¡¨

---

## ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. é‡æ–°éƒ¨ç½²ï¼ˆ5åˆ†é’Ÿï¼‰âœ…

```bash
cd D:\GoogleMapsScrapeWeb
netlify deploy --prod
```

**é¢„æœŸç»“æœï¼š**
- âœ… ä¸å†æœ‰ "supabaseKey is required" é”™è¯¯
- âœ… çœ‹åˆ°æ—¥å¿—ï¼š"âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ"
- âœ… å¯ä»¥æ­£å¸¸åˆ›å»ºè®¢å•

---

### 2. åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆ5åˆ†é’Ÿï¼‰â³

#### æ­¥éª¤1ï¼šç™»å½•Supabase
è®¿é—®ï¼šhttps://supabase.com/dashboard

#### æ­¥éª¤2ï¼šè¿›å…¥SQLç¼–è¾‘å™¨
1. é€‰æ‹©æ‚¨çš„é¡¹ç›®
2. ç‚¹å‡»å·¦ä¾§èœå•ï¼š**SQL Editor**
3. ç‚¹å‡»ï¼š**New query**

#### æ­¥éª¤3ï¼šæ‰§è¡ŒSQL
å¤åˆ¶å¹¶æ‰§è¡Œ `renewal_orders_table.sql` çš„å†…å®¹ï¼š

```sql
CREATE TABLE IF NOT EXISTS renewal_orders (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(100) UNIQUE NOT NULL,
    user_id VARCHAR(100) NOT NULL,
    username VARCHAR(255),
    renewal_type VARCHAR(20) NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    duration VARCHAR(50),
    product_name VARCHAR(255),
    status VARCHAR(20) DEFAULT 'pending',
    trade_no VARCHAR(100),
    new_expiry_date TIMESTAMPTZ,
    paid_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_renewal_orders_user_id ON renewal_orders(user_id);
CREATE INDEX IF NOT EXISTS idx_renewal_orders_order_id ON renewal_orders(order_id);
CREATE INDEX IF NOT EXISTS idx_renewal_orders_status ON renewal_orders(status);
CREATE INDEX IF NOT EXISTS idx_renewal_orders_created_at ON renewal_orders(created_at DESC);

-- åˆ›å»ºè§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_renewal_orders_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER renewal_orders_updated_at_trigger
BEFORE UPDATE ON renewal_orders
FOR EACH ROW
EXECUTE FUNCTION update_renewal_orders_updated_at();
```

#### æ­¥éª¤4ï¼šéªŒè¯
```sql
SELECT * FROM renewal_orders LIMIT 1;
```

åº”è¯¥è¿”å›ç©ºç»“æœï¼ˆè¡¨å·²åˆ›å»ºï¼Œä½†æ— æ•°æ®ï¼‰ã€‚

---

### 3. æµ‹è¯•å®Œæ•´æµç¨‹ï¼ˆ5åˆ†é’Ÿï¼‰âœ…

#### æµ‹è¯•åç«¯API
```bash
curl -X POST https://mediamingle.cn/.netlify/functions/createRenewalOrder \
  -H "Content-Type: application/json" \
  -d '{"userId":"test_user","username":"test@example.com","renewalType":"monthly","amount":29.90,"duration":"1ä¸ªæœˆ","productName":"è°·æ­Œåœ°å›¾å•†å®¶çˆ¬è™«-æœˆä»˜"}'
```

**é¢„æœŸå“åº”ï¼ˆçœŸå®æ¨¡å¼ï¼‰ï¼š**
```json
{
  "success": true,
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "orderId": "RENEW_1697720000000_abc123",
  "paymentUrl": "https://qr.alipay.com/..."
}
```

**æ³¨æ„ï¼š** åº”è¯¥**æ²¡æœ‰** `"mode": "mock"` å­—æ®µäº†ï¼

#### æµ‹è¯•å‰ç«¯
```bash
cd D:\gogole_maps
python Maps_scraper.py
```

1. ç‚¹å‡»ï¼š**å¸®åŠ©** â†’ **ç»­è´¹æœåŠ¡**
2. é€‰æ‹©ç»­è´¹æ–¹æ¡ˆ
3. ç‚¹å‡»ï¼š**ç”Ÿæˆæ”¯ä»˜äºŒç»´ç **
4. **é¢„æœŸï¼š** æˆåŠŸç”ŸæˆäºŒç»´ç ï¼Œè®¢å•ä¿å­˜åˆ°æ•°æ®åº“

#### éªŒè¯æ•°æ®åº“
åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­ï¼š
```sql
SELECT * FROM renewal_orders ORDER BY created_at DESC LIMIT 5;
```

åº”è¯¥èƒ½çœ‹åˆ°åˆšæ‰åˆ›å»ºçš„è®¢å•è®°å½•ã€‚

---

## ğŸ¯ ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ âŒ
```javascript
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY  // â† è¿™ä¸ªå˜é‡ä¸å­˜åœ¨
);
```

**ç»“æœï¼š**
```
Error: supabaseKey is required
```

### ä¿®å¤å âœ…
```javascript
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY ||  // â† ä½¿ç”¨æ­£ç¡®çš„åç§°
                     process.env.SUPABASE_SERVICE_KEY || 
                     process.env.SUPABASE_KEY;

if (supabaseUrl && supabaseKey) {
  supabase = createClient(supabaseUrl, supabaseKey);
  console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
}
```

**ç»“æœï¼š**
```
âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ
```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆä¹‹å‰ä¼šå‡ºé”™ï¼Ÿ

### é—®é¢˜æ ¹æº
æˆ‘ä»¬æŸ¥æ‰¾çš„ç¯å¢ƒå˜é‡åæ˜¯ `SUPABASE_SERVICE_KEY`ï¼Œä½†å®é™…å­˜åœ¨çš„æ˜¯ `SUPABASE_SERVICE_ROLE_KEY`ã€‚

### Supabaseæ ‡å‡†å‘½å
Supabaseå®˜æ–¹æ¨èçš„ç¯å¢ƒå˜é‡å‘½åï¼š
- âœ… `SUPABASE_URL` - é¡¹ç›®URL
- âœ… `SUPABASE_SERVICE_ROLE_KEY` - æœåŠ¡ç«¯å¯†é’¥ï¼ˆå®Œå…¨æƒé™ï¼‰
- âœ… `SUPABASE_ANON_KEY` - åŒ¿åå¯†é’¥ï¼ˆå—é™æƒé™ï¼‰

æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ `SUPABASE_SERVICE_KEY` æ˜¯ç®€åŒ–å‘½åï¼Œä¸æ˜¯å®˜æ–¹æ ‡å‡†ã€‚

---

## âœ… éªŒæ”¶æ ‡å‡†

### éƒ¨ç½²åéªŒæ”¶
- [ ] è¿è¡Œ `netlify deploy --prod` æˆåŠŸ
- [ ] Netlifyæ—¥å¿—ä¸­çœ‹åˆ° "âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ"
- [ ] æ²¡æœ‰ "supabaseKey is required" é”™è¯¯
- [ ] æ²¡æœ‰ "âš ï¸ Supabaseç¯å¢ƒå˜é‡æœªé…ç½®" è­¦å‘Š

### åŠŸèƒ½éªŒæ”¶
- [ ] curlæµ‹è¯•è¿”å›JSONï¼ˆæ—  `mode: "mock"`ï¼‰
- [ ] å‰ç«¯å¯ä»¥ç”ŸæˆäºŒç»´ç 
- [ ] è®¢å•ä¿å­˜åˆ°æ•°æ®åº“
- [ ] æ”¯ä»˜æ£€æµ‹å¯ä»¥å·¥ä½œ

### æ•°æ®åº“éªŒæ”¶
- [ ] `renewal_orders` è¡¨å·²åˆ›å»º
- [ ] ç´¢å¼•å·²åˆ›å»º
- [ ] è§¦å‘å™¨å·²åˆ›å»º
- [ ] å¯ä»¥æŸ¥è¯¢è®¢å•è®°å½•

---

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- âŒ ä½¿ç”¨äº†é”™è¯¯çš„ç¯å¢ƒå˜é‡å `SUPABASE_SERVICE_KEY`
- âŒ å®é™…å­˜åœ¨çš„æ˜¯ `SUPABASE_SERVICE_ROLE_KEY`

### è§£å†³
- âœ… ä¿®æ”¹ä»£ç ä½¿ç”¨æ­£ç¡®çš„ç¯å¢ƒå˜é‡å
- âœ… æ·»åŠ å…¼å®¹æ€§æ”¯æŒï¼ˆå°è¯•å¤šä¸ªå¯èƒ½çš„åç§°ï¼‰
- âœ… æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

### ç»“æœ
- âœ… ä¸å†éœ€è¦æ¨¡æ‹Ÿæ¨¡å¼
- âœ… å¯ä»¥ç›´æ¥ä½¿ç”¨çœŸå®æ•°æ®åº“
- âœ… å®Œæ•´çš„ç»­è´¹åŠŸèƒ½ç«‹å³å¯ç”¨

---

**ä¿®å¤æ—¶é—´ï¼š** 2024-10-19  
**çŠ¶æ€ï¼š** âœ… ç¯å¢ƒå˜é‡åç§°å·²ä¿®å¤  
**ä¸‹ä¸€æ­¥ï¼š** é‡æ–°éƒ¨ç½² + åˆ›å»ºæ•°æ®åº“è¡¨

ğŸŠ **å¤ªå¥½äº†ï¼åŸæ¥ç¯å¢ƒå˜é‡ä¸€ç›´éƒ½åœ¨ï¼** ğŸŠ

