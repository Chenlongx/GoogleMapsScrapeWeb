# ✅ 环境变量名称修复说明

## 🎉 好消息！

环境变量其实已经配置了，只是名称不同！

### 现有的环境变量
- ✅ `SUPABASE_URL` - 已存在
- ✅ `SUPABASE_SERVICE_ROLE_KEY` - 已存在（之前找的是 `SUPABASE_SERVICE_KEY`）
- ✅ `SUPABASE_ANON_KEY` - 已存在（可用于前端）

---

## 🔧 修复内容

### 修改了3个Netlify函数

所有函数现在会按优先级查找环境变量：

```javascript
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY ||  // ← 优先使用这个
                     process.env.SUPABASE_SERVICE_KEY ||       // ← 兼容性
                     process.env.SUPABASE_KEY;                 // ← 兜底
```

### 修改的文件
1. ✅ `createRenewalOrder.js` - 使用 `SUPABASE_SERVICE_ROLE_KEY`
2. ✅ `checkPaymentStatus.js` - 使用 `SUPABASE_SERVICE_ROLE_KEY`
3. ✅ `alipayCallback.js` - 使用 `SUPABASE_SERVICE_ROLE_KEY`

### 新增的日志
```javascript
if (supabaseUrl && supabaseKey) {
  supabase = createClient(supabaseUrl, supabaseKey);
  console.log('✅ Supabase客户端初始化成功');  // ← 新增成功日志
}
```

---

## 📋 环境变量说明

### SUPABASE_SERVICE_ROLE_KEY（服务端使用）✅
- **用途：** 服务端API密钥，拥有完全权限
- **使用场景：** Netlify函数（后端）
- **权限：** 完全权限，可以绕过RLS（Row Level Security）
- **安全性：** 只能在服务端使用，不能暴露给客户端

### SUPABASE_ANON_KEY（客户端使用）
- **用途：** 匿名API密钥，受RLS限制
- **使用场景：** 前端应用、移动应用
- **权限：** 受限权限，必须遵守RLS规则
- **安全性：** 可以公开，安全性由RLS保证

### SUPABASE_URL
- **用途：** Supabase项目的API端点
- **格式：** `https://xxxxx.supabase.co`
- **使用场景：** 前端和后端都需要

---

## 🚀 现在的状态

### ✅ 环境变量 - 已配置
- [x] SUPABASE_URL
- [x] SUPABASE_SERVICE_ROLE_KEY
- [x] SUPABASE_ANON_KEY

### ⏳ 数据库表 - 待创建
- [ ] renewal_orders 表

---

## 📝 下一步操作

### 1. 重新部署（5分钟）✅

```bash
cd D:\GoogleMapsScrapeWeb
netlify deploy --prod
```

**预期结果：**
- ✅ 不再有 "supabaseKey is required" 错误
- ✅ 看到日志："✅ Supabase客户端初始化成功"
- ✅ 可以正常创建订单

---

### 2. 创建数据库表（5分钟）⏳

#### 步骤1：登录Supabase
访问：https://supabase.com/dashboard

#### 步骤2：进入SQL编辑器
1. 选择您的项目
2. 点击左侧菜单：**SQL Editor**
3. 点击：**New query**

#### 步骤3：执行SQL
复制并执行 `renewal_orders_table.sql` 的内容：

```sql
CREATE TABLE IF NOT EXISTS renewal_orders (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(100) UNIQUE NOT NULL,
    user_id VARCHAR(100) NOT NULL,
    username VARCHAR(255),
    renewal_type VARCHAR(20) NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    duration VARCHAR(50),
    product_name VARCHAR(255),
    status VARCHAR(20) DEFAULT 'pending',
    trade_no VARCHAR(100),
    new_expiry_date TIMESTAMPTZ,
    paid_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_renewal_orders_user_id ON renewal_orders(user_id);
CREATE INDEX IF NOT EXISTS idx_renewal_orders_order_id ON renewal_orders(order_id);
CREATE INDEX IF NOT EXISTS idx_renewal_orders_status ON renewal_orders(status);
CREATE INDEX IF NOT EXISTS idx_renewal_orders_created_at ON renewal_orders(created_at DESC);

-- 创建触发器
CREATE OR REPLACE FUNCTION update_renewal_orders_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER renewal_orders_updated_at_trigger
BEFORE UPDATE ON renewal_orders
FOR EACH ROW
EXECUTE FUNCTION update_renewal_orders_updated_at();
```

#### 步骤4：验证
```sql
SELECT * FROM renewal_orders LIMIT 1;
```

应该返回空结果（表已创建，但无数据）。

---

### 3. 测试完整流程（5分钟）✅

#### 测试后端API
```bash
curl -X POST https://mediamingle.cn/.netlify/functions/createRenewalOrder \
  -H "Content-Type: application/json" \
  -d '{"userId":"test_user","username":"test@example.com","renewalType":"monthly","amount":29.90,"duration":"1个月","productName":"谷歌地图商家爬虫-月付"}'
```

**预期响应（真实模式）：**
```json
{
  "success": true,
  "message": "订单创建成功",
  "orderId": "RENEW_1697720000000_abc123",
  "paymentUrl": "https://qr.alipay.com/..."
}
```

**注意：** 应该**没有** `"mode": "mock"` 字段了！

#### 测试前端
```bash
cd D:\gogole_maps
python Maps_scraper.py
```

1. 点击：**帮助** → **续费服务**
2. 选择续费方案
3. 点击：**生成支付二维码**
4. **预期：** 成功生成二维码，订单保存到数据库

#### 验证数据库
在Supabase SQL编辑器中：
```sql
SELECT * FROM renewal_orders ORDER BY created_at DESC LIMIT 5;
```

应该能看到刚才创建的订单记录。

---

## 🎯 修复前后对比

### 修复前 ❌
```javascript
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY  // ← 这个变量不存在
);
```

**结果：**
```
Error: supabaseKey is required
```

### 修复后 ✅
```javascript
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY ||  // ← 使用正确的名称
                     process.env.SUPABASE_SERVICE_KEY || 
                     process.env.SUPABASE_KEY;

if (supabaseUrl && supabaseKey) {
  supabase = createClient(supabaseUrl, supabaseKey);
  console.log('✅ Supabase客户端初始化成功');
}
```

**结果：**
```
✅ Supabase客户端初始化成功
```

---

## 💡 为什么之前会出错？

### 问题根源
我们查找的环境变量名是 `SUPABASE_SERVICE_KEY`，但实际存在的是 `SUPABASE_SERVICE_ROLE_KEY`。

### Supabase标准命名
Supabase官方推荐的环境变量命名：
- ✅ `SUPABASE_URL` - 项目URL
- ✅ `SUPABASE_SERVICE_ROLE_KEY` - 服务端密钥（完全权限）
- ✅ `SUPABASE_ANON_KEY` - 匿名密钥（受限权限）

我们之前使用的 `SUPABASE_SERVICE_KEY` 是简化命名，不是官方标准。

---

## ✅ 验收标准

### 部署后验收
- [ ] 运行 `netlify deploy --prod` 成功
- [ ] Netlify日志中看到 "✅ Supabase客户端初始化成功"
- [ ] 没有 "supabaseKey is required" 错误
- [ ] 没有 "⚠️ Supabase环境变量未配置" 警告

### 功能验收
- [ ] curl测试返回JSON（无 `mode: "mock"`）
- [ ] 前端可以生成二维码
- [ ] 订单保存到数据库
- [ ] 支付检测可以工作

### 数据库验收
- [ ] `renewal_orders` 表已创建
- [ ] 索引已创建
- [ ] 触发器已创建
- [ ] 可以查询订单记录

---

## 🎉 总结

### 问题
- ❌ 使用了错误的环境变量名 `SUPABASE_SERVICE_KEY`
- ❌ 实际存在的是 `SUPABASE_SERVICE_ROLE_KEY`

### 解决
- ✅ 修改代码使用正确的环境变量名
- ✅ 添加兼容性支持（尝试多个可能的名称）
- ✅ 添加详细的日志输出

### 结果
- ✅ 不再需要模拟模式
- ✅ 可以直接使用真实数据库
- ✅ 完整的续费功能立即可用

---

**修复时间：** 2024-10-19  
**状态：** ✅ 环境变量名称已修复  
**下一步：** 重新部署 + 创建数据库表

🎊 **太好了！原来环境变量一直都在！** 🎊

