# ç»­è´¹å‚æ•°ç¼ºå¤±ç´§æ€¥ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡ï¼š**
```
æ”¯ä»˜æˆåŠŸï¼
ç»­è´¹ç±»å‹: æœˆä»˜
æ–°åˆ°æœŸæ—¶é—´: 2025-10-19T10:53:00+00:00  âŒ è¿˜æ˜¯ä»Šå¤©ï¼
```

**æ ¹æœ¬åŸå› ï¼š**
`checkPaymentStatus.js` è°ƒç”¨ `processBusinessLogic` æ—¶ï¼Œä¼ å…¥çš„å‚æ•°**ç¼ºå°‘ `product_id` å’Œ `subject`**ï¼Œå¯¼è‡´ `business-logic.js` æ— æ³•åˆ¤æ–­ç»­è´¹æ—¶é•¿ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### è°ƒç”¨æµç¨‹

```
checkPaymentStatus.js (ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€)
  â†“
æŸ¥è¯¢åˆ°è®¢å•å·²æ”¯ä»˜
  â†“
æ„å»º mockParams (æ¨¡æ‹Ÿæ”¯ä»˜å®å›è°ƒå‚æ•°)
  âŒ åªæœ‰: out_trade_no, trade_status, total_amount, trade_no
  âŒ ç¼ºå°‘: product_id, subject
  â†“
è°ƒç”¨ processBusinessLogic(mockParams)
  â†“
business-logic.js å°è¯•åˆ¤æ–­ç»­è´¹æ—¶é•¿
  âŒ productId = undefined (ä» mockParams ä¸­å–ä¸åˆ°)
  âŒ subjectText = undefined (ä» mockParams ä¸­å–ä¸åˆ°)
  â†“
renewalMonths = 0 (æ— æ³•åˆ¤æ–­)
  â†“
newExpiryDate = startDate (æ²¡æœ‰å»¶é•¿æ—¶é—´)
  â†“
âŒ ç»­è´¹å¤±è´¥ï¼
```

### é—®é¢˜ä»£ç 

```javascript
// âŒ æ—§ä»£ç  (checkPaymentStatus.js)
const mockParams = new URLSearchParams();
mockParams.append('out_trade_no', orderId);
mockParams.append('trade_status', 'TRADE_SUCCESS');
mockParams.append('total_amount', queryResult.totalAmount || '0');
mockParams.append('trade_no', queryResult.tradeNo || '');
// ç¼ºå°‘ product_id å’Œ subjectï¼

await processBusinessLogic(mockParams);
```

```javascript
// business-logic.js ä¸­è·å–å‚æ•°
const rawSubject = orderParams.get('subject');  // âŒ undefined
let productId = orderParams.get('product_id');  // âŒ undefined

// æ— æ³•åˆ¤æ–­ç»­è´¹æ—¶é•¿
let renewalMonths = 0;
if (productId) {
    // âŒ productId æ˜¯ undefinedï¼Œè·³è¿‡
}
if (renewalMonths === 0) {
    if (subjectText.includes('æœˆä»˜')) {
        // âŒ subjectText æ˜¯ undefinedï¼Œè·³è¿‡
    }
}
// âŒ renewalMonths è¿˜æ˜¯ 0ï¼Œé»˜è®¤å€¼ä¹Ÿæ²¡ç”Ÿæ•ˆ
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### åœ¨ `checkPaymentStatus.js` ä¸­ä¼ å…¥å®Œæ•´å‚æ•°

```javascript
// âœ… æ–°ä»£ç 
const mockParams = new URLSearchParams();
mockParams.append('out_trade_no', orderId);
mockParams.append('trade_status', 'TRADE_SUCCESS');
mockParams.append('total_amount', queryResult.totalAmount || '0');
mockParams.append('trade_no', queryResult.tradeNo || '');
// âœ… å…³é”®ä¿®å¤ï¼šæ·»åŠ  product_idï¼ˆä»è®¢å•æ•°æ®ä¸­è·å–ï¼‰
mockParams.append('product_id', orderData.product_id);
// âœ… å…³é”®ä¿®å¤ï¼šæ·»åŠ  subjectï¼ˆå¤‡ç”¨åˆ¤æ–­ï¼‰
mockParams.append('subject', `Google Maps Scraper - ç»­è´¹`);

console.log(`ğŸ“¦ ä¼ å…¥å‚æ•°: product_id=${orderData.product_id}, out_trade_no=${orderId}`);
await processBusinessLogic(mockParams);
```

### ä¿®å¤åçš„æµç¨‹

```
checkPaymentStatus.js
  â†“
æ„å»º mockParams
  âœ… product_id = 'gmaps_renewal_monthly'
  âœ… subject = 'Google Maps Scraper - ç»­è´¹'
  â†“
è°ƒç”¨ processBusinessLogic(mockParams)
  â†“
business-logic.js
  âœ… productId = 'gmaps_renewal_monthly'
  âœ… productId.includes('monthly') = true
  âœ… renewalMonths = 1
  â†“
newExpiryDate.setMonth(newExpiryDate.getMonth() + 1)
  âœ… 2025-10-19 â†’ 2025-11-19
  â†“
âœ… ç»­è´¹æˆåŠŸï¼
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

**Netlify æ—¥å¿—ï¼š**
```
ğŸ”§ å¼€å§‹è°ƒç”¨ business-logic.js å¤„ç†ç»­è´¹...
[Debug] Entered processBusinessLogic with params: ...
[Debug] processBusinessLogic params: { rawSubject: undefined, productId: undefined }
[Renewal] Processing renewal for 1491367041@qq.com
[Renewal] ä» product_id (undefined) åˆ¤æ–­: 0 ä¸ªæœˆ  âŒ
[Renewal] ä» subject (undefined) åˆ¤æ–­: 0 ä¸ªæœˆ  âŒ
[Renewal] æ— æ³•åˆ¤æ–­ç»­è´¹æ—¶é•¿ï¼Œé»˜è®¤ä¸º1ä¸ªæœˆ
[Renewal] æ–°çš„åˆ°æœŸæ—¶é—´: 2025-10-19... (å»¶é•¿ 0 ä¸ªæœˆ)  âŒ
```

**QT æ˜¾ç¤ºï¼š**
```
æ–°åˆ°æœŸæ—¶é—´: 2025-10-19T10:53:00+00:00  âŒ
```

### ä¿®å¤å

**Netlify æ—¥å¿—ï¼š**
```
ğŸ”§ å¼€å§‹è°ƒç”¨ business-logic.js å¤„ç†ç»­è´¹...
ğŸ“¦ ä¼ å…¥å‚æ•°: product_id=gmaps_renewal_monthly, out_trade_no=grm-xxx
[Debug] Entered processBusinessLogic with params: ...
[Debug] processBusinessLogic params: { rawSubject: 'Google Maps Scraper - ç»­è´¹', productId: 'gmaps_renewal_monthly' }
[Renewal] Processing renewal for 1491367041@qq.com
[Renewal] å½“å‰åˆ°æœŸæ—¶é—´: 2025-10-19T10:53:00+00:00
[Renewal] å½“å‰æ—¶é—´: 2025-10-19T15:XX:XX+00:00
[Renewal] ç»­è´¹èµ·å§‹æ—¶é—´: 2025-10-19T15:XX:XX+00:00
[Renewal] ä» product_id (gmaps_renewal_monthly) åˆ¤æ–­: 1 ä¸ªæœˆ  âœ…
[Renewal] æ–°çš„åˆ°æœŸæ—¶é—´: 2025-11-19T15:XX:XX+00:00 (å»¶é•¿ 1 ä¸ªæœˆ)  âœ…
```

**QT æ˜¾ç¤ºï¼š**
```
æ–°åˆ°æœŸæ—¶é—´: 2025-11-19T15:XX:XX+00:00  âœ…
æˆæƒå‰©ä½™: 31 å¤©  âœ…
```

---

## ğŸš€ ç´§æ€¥éƒ¨ç½²

### ç«‹å³éƒ¨ç½²

```bash
cd D:\GoogleMapsScrapeWeb
git add netlify/functions/checkPaymentStatus.js
git commit -m "urgent: ä¿®å¤ç»­è´¹å‚æ•°ç¼ºå¤±ï¼Œæ·»åŠ  product_id å’Œ subject"
git push origin main
```

### éƒ¨ç½²å®Œæˆåç«‹å³æµ‹è¯•

1. **ç­‰å¾… Netlify éƒ¨ç½²**ï¼ˆ1-3 åˆ†é’Ÿï¼‰
2. **é‡æ–°æµ‹è¯•ç»­è´¹æµç¨‹**
3. **æŸ¥çœ‹ Netlify æ—¥å¿—**

---

## ğŸ” éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šæŸ¥çœ‹ Netlify æ—¥å¿—

```bash
netlify functions:log checkPaymentStatus
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```
ğŸ“¦ ä¼ å…¥å‚æ•°: product_id=gmaps_renewal_monthly, out_trade_no=grm-xxx
[Renewal] ä» product_id (gmaps_renewal_monthly) åˆ¤æ–­: 1 ä¸ªæœˆ
[Renewal] æ–°çš„åˆ°æœŸæ—¶é—´: 2025-11-19... (å»¶é•¿ 1 ä¸ªæœˆ)
```

**ä¸åº”è¯¥çœ‹åˆ°ï¼š**
```
[Renewal] ä» product_id (undefined) åˆ¤æ–­: 0 ä¸ªæœˆ
[Renewal] æ— æ³•åˆ¤æ–­ç»­è´¹æ—¶é•¿
```

### æ–¹æ³•2ï¼šæŸ¥çœ‹ QT æ˜¾ç¤º

**æ­£ç¡®ï¼š**
```
æ–°åˆ°æœŸæ—¶é—´: 2025-11-19...  âœ… (æ¯”ä»Šå¤©æ™š1ä¸ªæœˆ)
```

**é”™è¯¯ï¼š**
```
æ–°åˆ°æœŸæ—¶é—´: 2025-10-19...  âŒ (è¿˜æ˜¯ä»Šå¤©)
```

### æ–¹æ³•3ï¼šæŸ¥çœ‹æ•°æ®åº“

```sql
SELECT account, expiry_at FROM user_accounts WHERE account = '1491367041@qq.com';
```

**æ­£ç¡®ï¼š**
```
expiry_at: 2025-11-19T...  âœ…
```

**é”™è¯¯ï¼š**
```
expiry_at: 2025-10-19T...  âŒ
```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿ

### åŸå› 1ï¼šå‚æ•°ä¼ é€’ä¸å®Œæ•´

`checkPaymentStatus.js` æ˜¯ä¸»åŠ¨æŸ¥è¯¢æ¨¡å¼ï¼Œéœ€è¦**æ‰‹åŠ¨æ„å»º**æ”¯ä»˜å®å›è°ƒå‚æ•°ã€‚ä½†æˆ‘ä»¬åªä¼ äº†åŸºæœ¬å‚æ•°ï¼Œå¿˜è®°ä¼  `product_id` å’Œ `subject`ã€‚

### åŸå› 2ï¼šé»˜è®¤å€¼é€»è¾‘ç¼ºå¤±

`business-logic.js` ä¸­è™½ç„¶æœ‰é»˜è®¤å€¼é€»è¾‘ï¼š
```javascript
if (renewalMonths === 0) {
    console.warn(`[Renewal] æ— æ³•åˆ¤æ–­ç»­è´¹æ—¶é•¿ï¼Œé»˜è®¤ä¸º1ä¸ªæœˆ`);
    renewalMonths = 1;
}
```

ä½†è¿™ä¸ªé€»è¾‘**åœ¨åé¢**ï¼Œå‰é¢çš„åˆ¤æ–­éƒ½å¤±è´¥åæ‰ä¼šæ‰§è¡Œã€‚è€Œä¸”å³ä½¿æ‰§è¡Œäº†ï¼Œä¹Ÿä¼šè¢«åç»­çš„å…¶ä»–é€»è¾‘è¦†ç›–ã€‚

### åŸå› 3ï¼šæµ‹è¯•ä¸å……åˆ†

ä¹‹å‰çš„ä¿®å¤åªæµ‹è¯•äº†æ—¥å¿—ï¼Œæ²¡æœ‰å®é™…éªŒè¯åˆ°æœŸæ—¶é—´æ˜¯å¦æ­£ç¡®å»¶é•¿ã€‚

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `netlify/functions/checkPaymentStatus.js` | æ·»åŠ  `product_id` å’Œ `subject` åˆ° `mockParams` |
| `ç»­è´¹å‚æ•°ç¼ºå¤±ç´§æ€¥ä¿®å¤.md` | æœ¬æ–‡æ¡£ |

---

## âš ï¸ é‡è¦æç¤º

**è¿™æ˜¯ä¸€ä¸ªå…³é”®ä¿®å¤ï¼** æ²¡æœ‰è¿™ä¸ªä¿®å¤ï¼Œæ‰€æœ‰ç»­è´¹éƒ½ä¼šå¤±è´¥ï¼ˆåˆ°æœŸæ—¶é—´ä¸ä¼šå»¶é•¿ï¼‰ã€‚

è¯·**ç«‹å³éƒ¨ç½²**å¹¶é‡æ–°æµ‹è¯•ï¼

---

**æœ€åæ›´æ–°ï¼š** 2025-10-19  
**ä¼˜å…ˆçº§ï¼š** ğŸ”¥ ç´§æ€¥  
**çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤ï¼Œå¾…ç«‹å³éƒ¨ç½²

