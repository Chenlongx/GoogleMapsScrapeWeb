# 续费参数缺失紧急修复

## 🐛 问题描述

**现象：**
```
支付成功！
续费类型: 月付
新到期时间: 2025-10-19T10:53:00+00:00  ❌ 还是今天！
```

**根本原因：**
`checkPaymentStatus.js` 调用 `processBusinessLogic` 时，传入的参数**缺少 `product_id` 和 `subject`**，导致 `business-logic.js` 无法判断续费时长。

---

## 🔍 问题分析

### 调用流程

```
checkPaymentStatus.js (主动查询支付状态)
  ↓
查询到订单已支付
  ↓
构建 mockParams (模拟支付宝回调参数)
  ❌ 只有: out_trade_no, trade_status, total_amount, trade_no
  ❌ 缺少: product_id, subject
  ↓
调用 processBusinessLogic(mockParams)
  ↓
business-logic.js 尝试判断续费时长
  ❌ productId = undefined (从 mockParams 中取不到)
  ❌ subjectText = undefined (从 mockParams 中取不到)
  ↓
renewalMonths = 0 (无法判断)
  ↓
newExpiryDate = startDate (没有延长时间)
  ↓
❌ 续费失败！
```

### 问题代码

```javascript
// ❌ 旧代码 (checkPaymentStatus.js)
const mockParams = new URLSearchParams();
mockParams.append('out_trade_no', orderId);
mockParams.append('trade_status', 'TRADE_SUCCESS');
mockParams.append('total_amount', queryResult.totalAmount || '0');
mockParams.append('trade_no', queryResult.tradeNo || '');
// 缺少 product_id 和 subject！

await processBusinessLogic(mockParams);
```

```javascript
// business-logic.js 中获取参数
const rawSubject = orderParams.get('subject');  // ❌ undefined
let productId = orderParams.get('product_id');  // ❌ undefined

// 无法判断续费时长
let renewalMonths = 0;
if (productId) {
    // ❌ productId 是 undefined，跳过
}
if (renewalMonths === 0) {
    if (subjectText.includes('月付')) {
        // ❌ subjectText 是 undefined，跳过
    }
}
// ❌ renewalMonths 还是 0，默认值也没生效
```

---

## ✅ 修复方案

### 在 `checkPaymentStatus.js` 中传入完整参数

```javascript
// ✅ 新代码
const mockParams = new URLSearchParams();
mockParams.append('out_trade_no', orderId);
mockParams.append('trade_status', 'TRADE_SUCCESS');
mockParams.append('total_amount', queryResult.totalAmount || '0');
mockParams.append('trade_no', queryResult.tradeNo || '');
// ✅ 关键修复：添加 product_id（从订单数据中获取）
mockParams.append('product_id', orderData.product_id);
// ✅ 关键修复：添加 subject（备用判断）
mockParams.append('subject', `Google Maps Scraper - 续费`);

console.log(`📦 传入参数: product_id=${orderData.product_id}, out_trade_no=${orderId}`);
await processBusinessLogic(mockParams);
```

### 修复后的流程

```
checkPaymentStatus.js
  ↓
构建 mockParams
  ✅ product_id = 'gmaps_renewal_monthly'
  ✅ subject = 'Google Maps Scraper - 续费'
  ↓
调用 processBusinessLogic(mockParams)
  ↓
business-logic.js
  ✅ productId = 'gmaps_renewal_monthly'
  ✅ productId.includes('monthly') = true
  ✅ renewalMonths = 1
  ↓
newExpiryDate.setMonth(newExpiryDate.getMonth() + 1)
  ✅ 2025-10-19 → 2025-11-19
  ↓
✅ 续费成功！
```

---

## 📊 修复前后对比

### 修复前

**Netlify 日志：**
```
🔧 开始调用 business-logic.js 处理续费...
[Debug] Entered processBusinessLogic with params: ...
[Debug] processBusinessLogic params: { rawSubject: undefined, productId: undefined }
[Renewal] Processing renewal for 1491367041@qq.com
[Renewal] 从 product_id (undefined) 判断: 0 个月  ❌
[Renewal] 从 subject (undefined) 判断: 0 个月  ❌
[Renewal] 无法判断续费时长，默认为1个月
[Renewal] 新的到期时间: 2025-10-19... (延长 0 个月)  ❌
```

**QT 显示：**
```
新到期时间: 2025-10-19T10:53:00+00:00  ❌
```

### 修复后

**Netlify 日志：**
```
🔧 开始调用 business-logic.js 处理续费...
📦 传入参数: product_id=gmaps_renewal_monthly, out_trade_no=grm-xxx
[Debug] Entered processBusinessLogic with params: ...
[Debug] processBusinessLogic params: { rawSubject: 'Google Maps Scraper - 续费', productId: 'gmaps_renewal_monthly' }
[Renewal] Processing renewal for 1491367041@qq.com
[Renewal] 当前到期时间: 2025-10-19T10:53:00+00:00
[Renewal] 当前时间: 2025-10-19T15:XX:XX+00:00
[Renewal] 续费起始时间: 2025-10-19T15:XX:XX+00:00
[Renewal] 从 product_id (gmaps_renewal_monthly) 判断: 1 个月  ✅
[Renewal] 新的到期时间: 2025-11-19T15:XX:XX+00:00 (延长 1 个月)  ✅
```

**QT 显示：**
```
新到期时间: 2025-11-19T15:XX:XX+00:00  ✅
授权剩余: 31 天  ✅
```

---

## 🚀 紧急部署

### 立即部署

```bash
cd D:\GoogleMapsScrapeWeb
git add netlify/functions/checkPaymentStatus.js
git commit -m "urgent: 修复续费参数缺失，添加 product_id 和 subject"
git push origin main
```

### 部署完成后立即测试

1. **等待 Netlify 部署**（1-3 分钟）
2. **重新测试续费流程**
3. **查看 Netlify 日志**

---

## 🔍 验证方法

### 方法1：查看 Netlify 日志

```bash
netlify functions:log checkPaymentStatus
```

**应该看到：**
```
📦 传入参数: product_id=gmaps_renewal_monthly, out_trade_no=grm-xxx
[Renewal] 从 product_id (gmaps_renewal_monthly) 判断: 1 个月
[Renewal] 新的到期时间: 2025-11-19... (延长 1 个月)
```

**不应该看到：**
```
[Renewal] 从 product_id (undefined) 判断: 0 个月
[Renewal] 无法判断续费时长
```

### 方法2：查看 QT 显示

**正确：**
```
新到期时间: 2025-11-19...  ✅ (比今天晚1个月)
```

**错误：**
```
新到期时间: 2025-10-19...  ❌ (还是今天)
```

### 方法3：查看数据库

```sql
SELECT account, expiry_at FROM user_accounts WHERE account = '1491367041@qq.com';
```

**正确：**
```
expiry_at: 2025-11-19T...  ✅
```

**错误：**
```
expiry_at: 2025-10-19T...  ❌
```

---

## 💡 为什么会有这个问题？

### 原因1：参数传递不完整

`checkPaymentStatus.js` 是主动查询模式，需要**手动构建**支付宝回调参数。但我们只传了基本参数，忘记传 `product_id` 和 `subject`。

### 原因2：默认值逻辑缺失

`business-logic.js` 中虽然有默认值逻辑：
```javascript
if (renewalMonths === 0) {
    console.warn(`[Renewal] 无法判断续费时长，默认为1个月`);
    renewalMonths = 1;
}
```

但这个逻辑**在后面**，前面的判断都失败后才会执行。而且即使执行了，也会被后续的其他逻辑覆盖。

### 原因3：测试不充分

之前的修复只测试了日志，没有实际验证到期时间是否正确延长。

---

## 📝 相关文件

| 文件 | 修改内容 |
|------|---------|
| `netlify/functions/checkPaymentStatus.js` | 添加 `product_id` 和 `subject` 到 `mockParams` |
| `续费参数缺失紧急修复.md` | 本文档 |

---

## ⚠️ 重要提示

**这是一个关键修复！** 没有这个修复，所有续费都会失败（到期时间不会延长）。

请**立即部署**并重新测试！

---

**最后更新：** 2025-10-19  
**优先级：** 🔥 紧急  
**状态：** ✅ 已修复，待立即部署

