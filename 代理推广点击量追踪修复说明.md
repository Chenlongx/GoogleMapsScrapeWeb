# ä»£ç†æ¨å¹¿ç‚¹å‡»é‡è¿½è¸ªä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ä»£ç†ä»ªè¡¨æ¿ä¸­æ— æ³•æ˜¾ç¤ºæ¨å¹¿ç‚¹å‡»é‡ç»Ÿè®¡ï¼Œå¯¼è‡´ä»£ç†æ— æ³•äº†è§£è‡ªå·±çš„æ¨å¹¿é“¾æ¥è¢«ç‚¹å‡»çš„æƒ…å†µã€‚

## é—®é¢˜åˆ†æ

1. **åç«¯æ•°æ®è·å–ä¸å®Œæ•´**ï¼š`getAgentDashboard.js` æ²¡æœ‰è·å–æ¨å¹¿ç‚¹å‡»é‡æ•°æ®
2. **å‰ç«¯æ˜¾ç¤ºç¼ºå¤±**ï¼šä»£ç†ä»ªè¡¨æ¿é¡µé¢æ²¡æœ‰æ˜¾ç¤ºæ¨å¹¿ç‚¹å‡»é‡çš„UIå…ƒç´ 
3. **æ•°æ®ç»Ÿè®¡ä¸å‡†ç¡®**ï¼šç¼ºå°‘æ¨å¹¿ç‚¹å‡»é‡çš„ç»Ÿè®¡è®¡ç®—

## ä¿®å¤å†…å®¹

### 1. ä¿®å¤åç«¯æ•°æ®è·å– (`getAgentDashboard.js`)

**æ–°å¢æ¨å¹¿ç‚¹å‡»é‡æ•°æ®è·å–ï¼š**
```javascript
// 8. è·å–æ¨å¹¿ç‚¹å‡»é‡ç»Ÿè®¡
const { data: promotionClicks } = await supabase
  .from('promotion_clicks')
  .select('*')
  .eq('agent_id', agentProfile.id)
  .order('clicked_at', { ascending: false });

// 9. è·å–æ¨å¹¿è®°å½•ç»Ÿè®¡
const { data: promotionStats } = await supabase
  .from('product_promotions')
  .select('clicks_count, conversions_count, total_commission')
  .eq('agent_id', agentProfile.id);

// è®¡ç®—æ¨å¹¿ç»Ÿè®¡æ•°æ®
const totalClicks = promotionClicks?.length || 0;
const totalConversions = promotionStats?.reduce((sum, stat) => sum + (stat.conversions_count || 0), 0) || 0;
const totalPromotionCommission = promotionStats?.reduce((sum, stat) => sum + parseFloat(stat.total_commission || 0), 0) || 0;

// 10. è·å–ä»Šæ—¥ç‚¹å‡»é‡
const today = new Date();
today.setHours(0, 0, 0, 0);
const { data: todayClicks } = await supabase
  .from('promotion_clicks')
  .select('*')
  .eq('agent_id', agentProfile.id)
  .gte('clicked_at', today.toISOString());

const todayClicksCount = todayClicks?.length || 0;
```

**æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼š**
```javascript
const stats = {
  totalCommission: parseFloat(agentProfile.total_commission) || 0,
  availableBalance: parseFloat(agentProfile.available_balance) || 0,
  monthlyCommission: monthlyCommission,
  pendingCommission: pendingCommissionAmount,
  subAgentsCount: subAgentsCount || 0,
  teamMembersCount: teamMembers?.length || 0,
  // æ¨å¹¿ç»Ÿè®¡æ•°æ®
  totalClicks: totalClicks,
  totalConversions: totalConversions,
  totalPromotionCommission: totalPromotionCommission,
  todayClicks: todayClicksCount
};
```

### 2. ä¿®å¤å‰ç«¯æ˜¾ç¤º (`agent-dashboard.html`)

**æ–°å¢ä»ªè¡¨æ¿æ¦‚è§ˆç»Ÿè®¡å¡ç‰‡ï¼š**
```html
<div class="stat-card">
    <div class="stat-icon primary">
        <i class="fas fa-mouse-pointer"></i>
    </div>
    <div class="stat-content">
        <h3 id="totalClicks">0</h3>
        <p>æ€»ç‚¹å‡»é‡</p>
    </div>
</div>
<div class="stat-card">
    <div class="stat-icon secondary">
        <i class="fas fa-chart-line"></i>
    </div>
    <div class="stat-content">
        <h3 id="todayClicks">0</h3>
        <p>ä»Šæ—¥ç‚¹å‡»</p>
    </div>
</div>
<div class="stat-card">
    <div class="stat-icon warning">
        <i class="fas fa-shopping-cart"></i>
    </div>
    <div class="stat-content">
        <h3 id="totalConversions">0</h3>
        <p>æ€»è½¬åŒ–æ•°</p>
    </div>
</div>
```

**æ–°å¢æ¨å¹¿ç»Ÿè®¡é¡µé¢ç»Ÿè®¡å¡ç‰‡ï¼š**
```html
<div class="stat-card">
    <div class="stat-icon">ğŸ–±ï¸</div>
    <div class="stat-content">
        <h3 id="promotionTotalClicks">0</h3>
        <p>æ¨å¹¿æ€»ç‚¹å‡»</p>
    </div>
</div>
<div class="stat-card">
    <div class="stat-icon">ğŸ“Š</div>
    <div class="stat-content">
        <h3 id="promotionTodayClicks">0</h3>
        <p>ä»Šæ—¥ç‚¹å‡»</p>
    </div>
</div>
<div class="stat-card">
    <div class="stat-icon">ğŸ¯</div>
    <div class="stat-content">
        <h3 id="promotionConversions">0</h3>
        <p>æ¨å¹¿è½¬åŒ–</p>
    </div>
</div>
<div class="stat-card">
    <div class="stat-icon">ğŸ’</div>
    <div class="stat-content">
        <h3 id="promotionCommission">Â¥0</h3>
        <p>æ¨å¹¿ä½£é‡‘</p>
    </div>
</div>
```

**æ–°å¢æ¨å¹¿ç‚¹å‡»è®°å½•è¡¨æ ¼ï¼š**
```html
<div class="promoted-users-table">
    <h3>æ¨å¹¿ç‚¹å‡»è®°å½•</h3>
    <table class="table">
        <thead>
            <tr>
                <th>ç‚¹å‡»æ—¶é—´</th>
                <th>æ¨å¹¿ç </th>
                <th>IPåœ°å€</th>
                <th>æ¥æºé¡µé¢</th>
                <th>ç”¨æˆ·ä»£ç†</th>
            </tr>
        </thead>
        <tbody id="promotionClicksTableBody">
        </tbody>
    </table>
</div>
```

### 3. ä¿®å¤å‰ç«¯JavaScripté€»è¾‘

**æ›´æ–°ä»ªè¡¨æ¿æ•°æ®æ˜¾ç¤ºï¼š**
```javascript
function updateDashboard(data) {
    document.getElementById('totalCommission').textContent = `Â¥${data.stats.totalCommission}`;
    document.getElementById('availableBalance').textContent = `Â¥${data.stats.availableBalance}`;
    document.getElementById('pendingCommission').textContent = `Â¥${data.stats.pendingCommission}`;
    document.getElementById('teamCount').textContent = data.stats.teamMembersCount;
    
    // æ›´æ–°æ¨å¹¿ç‚¹å‡»é‡ç»Ÿè®¡
    document.getElementById('totalClicks').textContent = data.stats.totalClicks || 0;
    document.getElementById('todayClicks').textContent = data.stats.todayClicks || 0;
    document.getElementById('totalConversions').textContent = data.stats.totalConversions || 0;
    
    // æ˜¾ç¤ºæ¨å¹¿ç‚¹å‡»è®°å½•
    if (data.promotionClicks && data.promotionClicks.length > 0) {
        displayPromotionClicks(data.promotionClicks);
    }
}
```

**æ–°å¢æ¨å¹¿ç‚¹å‡»è®°å½•æ˜¾ç¤ºå‡½æ•°ï¼š**
```javascript
function displayPromotionClicks(clicks) {
    const tbody = document.getElementById('promotionClicksTableBody');
    tbody.innerHTML = '';
    
    if (!clicks || clicks.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" style="text-align: center; color: #999;">æš‚æ— ç‚¹å‡»è®°å½•</td>';
        tbody.appendChild(row);
        return;
    }
    
    clicks.slice(0, 20).forEach(click => { // åªæ˜¾ç¤ºæœ€è¿‘20æ¡è®°å½•
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(click.clicked_at).toLocaleString('zh-CN')}</td>
            <td>${click.promotion_code}</td>
            <td>${click.ip_address || 'æœªçŸ¥'}</td>
            <td>${click.referrer || 'ç›´æ¥è®¿é—®'}</td>
            <td title="${click.user_agent || ''}">${(click.user_agent || '').substring(0, 50)}${(click.user_agent || '').length > 50 ? '...' : ''}</td>
        `;
        tbody.appendChild(row);
    });
}
```

## æ•°æ®åº“è¡¨ç»“æ„

ä¿®å¤ä¾èµ–äºä»¥ä¸‹æ•°æ®åº“è¡¨ï¼š

### 1. `promotion_clicks` è¡¨
```sql
CREATE TABLE IF NOT EXISTS promotion_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  promotion_code VARCHAR(100) NOT NULL,
  agent_id UUID REFERENCES agent_profiles(id),
  ip_address INET,
  user_agent TEXT,
  referrer TEXT,
  clicked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2. `product_promotions` è¡¨
```sql
CREATE TABLE IF NOT EXISTS product_promotions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agent_id UUID REFERENCES agent_profiles(id) ON DELETE CASCADE,
  product_type VARCHAR(50) NOT NULL,
  promotion_code VARCHAR(100) UNIQUE NOT NULL,
  commission_rate DECIMAL(5,2) NOT NULL,
  status VARCHAR(20) DEFAULT 'active',
  clicks_count INTEGER DEFAULT 0, -- ç‚¹å‡»æ¬¡æ•°
  conversions_count INTEGER DEFAULT 0, -- è½¬åŒ–æ¬¡æ•°
  total_commission DECIMAL(10,2) DEFAULT 0.00, -- ç´¯è®¡ä½£é‡‘
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## æ¨å¹¿ç‚¹å‡»è¿½è¸ªæµç¨‹

### 1. ç”¨æˆ·ç‚¹å‡»æ¨å¹¿é“¾æ¥
- æ¨å¹¿é“¾æ¥æ ¼å¼ï¼š`https://mediamingle.cn/product.html?id=maps-scraper&ref=AGENT_CODE_PRODUCT_TYPE_TIMESTAMP_RANDOM`
- æ¨å¹¿è¿½è¸ªå™¨è‡ªåŠ¨è§£ææ¨å¹¿å‚æ•°

### 2. æ¨å¹¿è¿½è¸ªå™¨è®°å½•ç‚¹å‡»
- è°ƒç”¨ `trackReferralClick()` å‡½æ•°
- å‘é€POSTè¯·æ±‚åˆ° `/api/trackReferralClick`
- è®°å½•ç‚¹å‡»ä¿¡æ¯åˆ° `promotion_clicks` è¡¨
- æ›´æ–° `product_promotions` è¡¨çš„ `clicks_count`

### 3. ä»£ç†ä»ªè¡¨æ¿æ˜¾ç¤ºç»Ÿè®¡
- ä» `promotion_clicks` è¡¨è·å–ç‚¹å‡»è®°å½•
- ä» `product_promotions` è¡¨è·å–ç»Ÿè®¡æ•°æ®
- è®¡ç®—æ€»ç‚¹å‡»é‡ã€ä»Šæ—¥ç‚¹å‡»é‡ã€è½¬åŒ–æ•°ç­‰
- åœ¨ä»ªè¡¨æ¿ä¸­æ˜¾ç¤ºç»Ÿè®¡æ•°æ®å’Œè¯¦ç»†è®°å½•

## æµ‹è¯•æ–¹æ³•

### 1. æµ‹è¯•æ¨å¹¿é“¾æ¥ç‚¹å‡»è¿½è¸ª
1. ç”Ÿæˆæ¨å¹¿é“¾æ¥
2. ä½¿ç”¨æ¨å¹¿é“¾æ¥è®¿é—®äº§å“é¡µé¢
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ "MediaMingleæ¨å¹¿ç‚¹å‡»è®°å½•æˆåŠŸ" æ—¥å¿—
4. æ£€æŸ¥æ•°æ®åº“ä¸­ `promotion_clicks` è¡¨æ˜¯å¦æœ‰æ–°è®°å½•

### 2. æµ‹è¯•ä»£ç†ä»ªè¡¨æ¿æ˜¾ç¤º
1. ç™»å½•ä»£ç†è´¦æˆ·
2. æŸ¥çœ‹ä»ªè¡¨æ¿æ¦‚è§ˆé¡µé¢çš„ç‚¹å‡»é‡ç»Ÿè®¡
3. åˆ‡æ¢åˆ°æ¨å¹¿ç»Ÿè®¡é¡µé¢æŸ¥çœ‹è¯¦ç»†æ•°æ®
4. æ£€æŸ¥æ¨å¹¿ç‚¹å‡»è®°å½•è¡¨æ ¼æ˜¯å¦æ˜¾ç¤ºç‚¹å‡»è®°å½•

### 3. æµ‹è¯•æ•°æ®å‡†ç¡®æ€§
1. å¤šæ¬¡ç‚¹å‡»æ¨å¹¿é“¾æ¥
2. æ£€æŸ¥ä»ªè¡¨æ¿ä¸­çš„ç‚¹å‡»é‡æ˜¯å¦å®æ—¶æ›´æ–°
3. éªŒè¯ä»Šæ—¥ç‚¹å‡»é‡ä¸æ€»ç‚¹å‡»é‡çš„å…³ç³»

## éƒ¨ç½²æ­¥éª¤

### 1. éƒ¨ç½²åç«¯ä»£ç 
```bash
# æäº¤ä¿®æ”¹çš„æ–‡ä»¶
git add netlify/functions/getAgentDashboard.js
git commit -m "ä¿®å¤ä»£ç†æ¨å¹¿ç‚¹å‡»é‡è¿½è¸ªåŠŸèƒ½"
git push origin main
```

### 2. éƒ¨ç½²å‰ç«¯ä»£ç 
```bash
# æäº¤ä¿®æ”¹çš„æ–‡ä»¶
git add public/agent-dashboard.html
git commit -m "æ·»åŠ æ¨å¹¿ç‚¹å‡»é‡ç»Ÿè®¡æ˜¾ç¤º"
git push origin main
```

### 3. éªŒè¯éƒ¨ç½²
1. ç­‰å¾…Netlifyè‡ªåŠ¨éƒ¨ç½²å®Œæˆ
2. æµ‹è¯•æ¨å¹¿é“¾æ¥ç‚¹å‡»è¿½è¸ª
3. æ£€æŸ¥ä»£ç†ä»ªè¡¨æ¿æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸

## ç›‘æ§è¦ç‚¹

### 1. æ¨å¹¿ç‚¹å‡»è¿½è¸ªç›‘æ§
- æ£€æŸ¥ `trackReferralClick` å‡½æ•°æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
- ç›‘æ§ `promotion_clicks` è¡¨çš„æ•°æ®å¢é•¿
- å…³æ³¨æ¨å¹¿è¿½è¸ªå™¨çš„é”™è¯¯æ—¥å¿—

### 2. ä»£ç†ä»ªè¡¨æ¿ç›‘æ§
- æ£€æŸ¥ç»Ÿè®¡æ•°æ®æ˜¯å¦å‡†ç¡®æ˜¾ç¤º
- ç›‘æ§é¡µé¢åŠ è½½æ€§èƒ½
- å…³æ³¨ç”¨æˆ·åé¦ˆå’Œæ•°æ®å¼‚å¸¸

### 3. æ•°æ®åº“æ€§èƒ½ç›‘æ§
- ç›‘æ§ `promotion_clicks` è¡¨çš„æŸ¥è¯¢æ€§èƒ½
- å…³æ³¨æ•°æ®é‡å¢é•¿å¯¹æ€§èƒ½çš„å½±å“
- å®šæœŸæ¸…ç†è¿‡æœŸçš„ç‚¹å‡»è®°å½•

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¿®å¤ï¼Œä»£ç†æ¨å¹¿ç‚¹å‡»é‡è¿½è¸ªåŠŸèƒ½ç°åœ¨èƒ½å¤Ÿï¼š

1. âœ… **æ­£ç¡®è®°å½•æ¨å¹¿é“¾æ¥ç‚¹å‡»**ï¼šæ¯æ¬¡ç‚¹å‡»éƒ½ä¼šè®°å½•åˆ°æ•°æ®åº“
2. âœ… **å®æ—¶æ˜¾ç¤ºç‚¹å‡»é‡ç»Ÿè®¡**ï¼šä»ªè¡¨æ¿æ˜¾ç¤ºæ€»ç‚¹å‡»é‡ã€ä»Šæ—¥ç‚¹å‡»é‡ç­‰
3. âœ… **æä¾›è¯¦ç»†çš„ç‚¹å‡»è®°å½•**ï¼šæ˜¾ç¤ºç‚¹å‡»æ—¶é—´ã€IPåœ°å€ã€æ¥æºç­‰ä¿¡æ¯
4. âœ… **è®¡ç®—è½¬åŒ–ç‡æ•°æ®**ï¼šæ˜¾ç¤ºç‚¹å‡»è½¬åŒ–æƒ…å†µå’Œä½£é‡‘ç»Ÿè®¡
5. âœ… **æ”¯æŒå¤šç»´åº¦ç»Ÿè®¡**ï¼šæŒ‰æ—¶é—´ã€äº§å“ç±»å‹ç­‰ç»´åº¦ç»Ÿè®¡

ç°åœ¨ä»£ç†å¯ä»¥æ¸…æ¥šåœ°äº†è§£è‡ªå·±çš„æ¨å¹¿é“¾æ¥è¢«ç‚¹å‡»çš„æƒ…å†µï¼Œæ›´å¥½åœ°ä¼˜åŒ–æ¨å¹¿ç­–ç•¥ã€‚

