# æ”¯ä»˜å®é›†æˆè¯´æ˜

## âŒ å½“å‰é—®é¢˜

**é”™è¯¯ä¿¡æ¯ï¼š**
```
è°ƒè¯•é”™è¯¯ï¼Œè¯·å›åˆ°è¯·æ±‚æ¥æºåœ°ï¼Œé‡æ–°å‘èµ·è¯·æ±‚
ä»£ç é”™è¯¯ missing-app-id
é”™è¯¯åŸå› ï¼šç¼ºå°‘AppIDå‚æ•°
```

**åŸå› åˆ†æï¼š**
ç”Ÿæˆçš„æ”¯ä»˜å®URLç¼ºå°‘å¿…éœ€çš„ `app_id` å‚æ•°å’Œå…¶ä»–å…³é”®å‚æ•°ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ æ”¯ä»˜å®å¿…éœ€å‚æ•°

ä¿®æ”¹ `generateAlipayUrl` å‡½æ•°ï¼Œæ·»åŠ å®Œæ•´çš„æ”¯ä»˜å®å‚æ•°ï¼š

```javascript
const params = {
  // å¿…éœ€å‚æ•°
  app_id: alipayAppId,              // æ”¯ä»˜å®AppID
  method: 'alipay.trade.wap.pay',   // æ¥å£åç§°
  format: 'JSON',
  charset: 'utf-8',
  sign_type: 'RSA2',
  timestamp: 'yyyy-MM-dd HH:mm:ss',
  version: '1.0',
  
  // ä¸šåŠ¡å‚æ•°
  biz_content: JSON.stringify({
    out_trade_no: orderId,
    total_amount: amount.toFixed(2),
    subject: subject,
    product_code: 'QUICK_WAP_PAY'
  }),
  
  // å›è°ƒåœ°å€
  notify_url: 'https://mediamingle.cn/.netlify/functions/alipayCallback',
  return_url: 'https://mediamingle.cn/payment-success.html'
};
```

### 2. ç¯å¢ƒå˜é‡æ£€æŸ¥

æ·»åŠ ç¯å¢ƒå˜é‡æ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰é…ç½®æ”¯ä»˜å®ï¼Œè¿”å›æµ‹è¯•URLï¼š

```javascript
const alipayAppId = process.env.ALIPAY_APP_ID;

if (!alipayAppId) {
  console.warn('âš ï¸ æœªé…ç½®æ”¯ä»˜å®å‚æ•°ï¼Œè¿”å›æµ‹è¯•URL');
  return `https://mediamingle.cn/test-payment?orderId=${orderId}&...`;
}
```

---

## ğŸ”§ å®Œæ•´é›†æˆæ­¥éª¤

### æ­¥éª¤1ï¼šç”³è¯·æ”¯ä»˜å®åº”ç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

1. è®¿é—®ï¼šhttps://open.alipay.com
2. æ³¨å†Œå¹¶åˆ›å»ºåº”ç”¨
3. é€‰æ‹©"ç½‘é¡µ/ç§»åŠ¨åº”ç”¨"
4. æäº¤èµ„è´¨å®¡æ ¸

**è·å–çš„ä¿¡æ¯ï¼š**
- App IDï¼ˆåº”ç”¨IDï¼‰
- åº”ç”¨ç§é’¥ï¼ˆRSA2ï¼‰
- æ”¯ä»˜å®å…¬é’¥

---

### æ­¥éª¤2ï¼šç”ŸæˆRSAå¯†é’¥å¯¹

ä½¿ç”¨æ”¯ä»˜å®æä¾›çš„å¯†é’¥ç”Ÿæˆå·¥å…·ï¼š

**Windowsï¼š**
```cmd
# ä¸‹è½½æ”¯ä»˜å®å¯†é’¥ç”Ÿæˆå·¥å…·
# https://opendocs.alipay.com/common/02kipl

# ç”Ÿæˆ2048ä½RSAå¯†é’¥å¯¹
# ä¼šç”Ÿæˆï¼šåº”ç”¨ç§é’¥ã€åº”ç”¨å…¬é’¥
```

**Linux/Macï¼š**
```bash
# ç”Ÿæˆç§é’¥
openssl genrsa -out app_private_key.pem 2048

# ç”Ÿæˆå…¬é’¥
openssl rsa -in app_private_key.pem -pubout -out app_public_key.pem
```

---

### æ­¥éª¤3ï¼šé…ç½®Netlifyç¯å¢ƒå˜é‡

åœ¨Netlifyæ§åˆ¶å°æ·»åŠ ï¼š

```
ALIPAY_APP_ID=2021001234567890
ALIPAY_PRIVATE_KEY=MIIEvQIBADANBgkqhkiG9w0BAQ...
ALIPAY_PUBLIC_KEY=MIIBIjANBgkqhkiG9w0BAQEF...
```

**é‡è¦æç¤ºï¼š**
- ç§é’¥æ ¼å¼ï¼šå»æ‰ `-----BEGIN PRIVATE KEY-----` ç­‰å¤´å°¾
- æˆ–ä¿ç•™å®Œæ•´æ ¼å¼ï¼Œä»£ç ä¸­å¤„ç†

---

### æ­¥éª¤4ï¼šå®‰è£…æ”¯ä»˜å®SDKï¼ˆæ¨èï¼‰

```bash
cd D:\GoogleMapsScrapeWeb
npm install alipay-sdk --save
```

**ä½¿ç”¨SDKï¼š**
```javascript
const AlipaySdk = require('alipay-sdk').default;

const alipaySdk = new AlipaySdk({
  appId: process.env.ALIPAY_APP_ID,
  privateKey: process.env.ALIPAY_PRIVATE_KEY,
  alipayPublicKey: process.env.ALIPAY_PUBLIC_KEY,
  gateway: 'https://openapi.alipay.com/gateway.do'
});

// ç”Ÿæˆæ”¯ä»˜URL
const paymentUrl = alipaySdk.generatePageUrl({
  method: 'alipay.trade.wap.pay',
  bizContent: {
    outTradeNo: orderId,
    totalAmount: amount.toFixed(2),
    subject: subject,
    productCode: 'QUICK_WAP_PAY'
  },
  returnUrl: 'https://mediamingle.cn/payment-success.html',
  notifyUrl: 'https://mediamingle.cn/.netlify/functions/alipayCallback'
});
```

---

### æ­¥éª¤5ï¼šæ›´æ–° createRenewalOrder.js

å¦‚æœä½¿ç”¨SDKï¼š

```javascript
const AlipaySdk = require('alipay-sdk').default;

// åˆå§‹åŒ–SDK
let alipaySdk = null;
if (process.env.ALIPAY_APP_ID) {
  alipaySdk = new AlipaySdk({
    appId: process.env.ALIPAY_APP_ID,
    privateKey: process.env.ALIPAY_PRIVATE_KEY,
    alipayPublicKey: process.env.ALIPAY_PUBLIC_KEY,
    gateway: 'https://openapi.alipay.com/gateway.do'
  });
}

function generateAlipayUrl(orderId, amount, subject) {
  if (!alipaySdk) {
    // è¿”å›æµ‹è¯•URL
    return `https://mediamingle.cn/test-payment?orderId=${orderId}`;
  }
  
  // ä½¿ç”¨SDKç”Ÿæˆæ”¯ä»˜URL
  return alipaySdk.generatePageUrl({
    method: 'alipay.trade.wap.pay',
    bizContent: {
      outTradeNo: orderId,
      totalAmount: amount.toFixed(2),
      subject: subject,
      productCode: 'QUICK_WAP_PAY'
    },
    returnUrl: `https://mediamingle.cn/payment-success.html?orderId=${orderId}`,
    notifyUrl: 'https://mediamingle.cn/.netlify/functions/alipayCallback'
  });
}
```

---

## ğŸ¯ å½“å‰çŠ¶æ€

### ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆå·²å®ç°ï¼‰âœ…

**åŠŸèƒ½ï¼š**
- âœ… æ£€æŸ¥ç¯å¢ƒå˜é‡
- âœ… æ·»åŠ å¿…éœ€çš„æ”¯ä»˜å®å‚æ•°
- âœ… æœªé…ç½®æ—¶è¿”å›æµ‹è¯•URL
- âœ… å¯ä»¥ç”ŸæˆäºŒç»´ç ï¼ˆä½†ä¸èƒ½çœŸå®æ”¯ä»˜ï¼‰

**é™åˆ¶ï¼š**
- âš ï¸ ç¼ºå°‘RSA2ç­¾åï¼ŒçœŸå®æ”¯ä»˜ä¼šå¤±è´¥
- âš ï¸ ä»…ç”¨äºUIæµ‹è¯•

---

### å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ˆå¾…å®æ–½ï¼‰â³

**éœ€è¦åšçš„ï¼š**
1. ç”³è¯·æ”¯ä»˜å®åº”ç”¨
2. ç”ŸæˆRSAå¯†é’¥å¯¹
3. é…ç½®ç¯å¢ƒå˜é‡
4. å®‰è£…æ”¯ä»˜å®SDK
5. å®ç°ç­¾åé€»è¾‘

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•1ï¼šå½“å‰ä¿®å¤ï¼ˆä¸éœ€è¦æ”¯ä»˜å®ï¼‰

```bash
# 1. é‡æ–°éƒ¨ç½²
cd D:\GoogleMapsScrapeWeb
netlify deploy --prod

# 2. æµ‹è¯•å‰ç«¯
cd D:\gogole_maps
python Maps_scraper.py
```

**é¢„æœŸç»“æœï¼š**
- âœ… å¯ä»¥ç”ŸæˆäºŒç»´ç 
- âœ… ä¸å†æ˜¾ç¤º "missing-app-id" é”™è¯¯
- âœ… äºŒç»´ç å¯ä»¥æ­£å¸¸æ˜¾ç¤º
- âš ï¸ æ‰«ç åä¼šè·³è½¬åˆ°æµ‹è¯•é¡µé¢

---

### æµ‹è¯•2ï¼šé…ç½®æ”¯ä»˜å®åï¼ˆçœŸå®æ”¯ä»˜ï¼‰

```bash
# 1. åœ¨Netlifyé…ç½®ç¯å¢ƒå˜é‡
# 2. å®‰è£…SDK
npm install alipay-sdk

# 3. æ›´æ–°ä»£ç ä½¿ç”¨SDK
# 4. é‡æ–°éƒ¨ç½²
netlify deploy --prod
```

**é¢„æœŸç»“æœï¼š**
- âœ… ç”ŸæˆçœŸå®æ”¯ä»˜å®æ”¯ä»˜URL
- âœ… æ‰«ç åå¯ä»¥çœŸå®æ”¯ä»˜
- âœ… æ”¯ä»˜æˆåŠŸåå›è°ƒç”Ÿæ•ˆ

---

## ğŸ“Š URLå¯¹æ¯”

### é”™è¯¯çš„URLï¼ˆç¼ºå°‘app_idï¼‰âŒ
```
https://openapi.alipay.com/gateway.do?
  out_trade_no=RNW-123&
  total_amount=29.90&
  subject=ç»­è´¹&
  method=alipay.trade.wap.pay
```

### ä¸´æ—¶ä¿®å¤çš„URLï¼ˆæœ‰app_idä½†æ— ç­¾åï¼‰âš ï¸
```
https://openapi.alipay.com/gateway.do?
  app_id=2021001234567890&
  method=alipay.trade.wap.pay&
  format=JSON&
  charset=utf-8&
  sign_type=RSA2&
  timestamp=2024-10-19%2012:00:00&
  version=1.0&
  biz_content={"out_trade_no":"RNW-123","total_amount":"29.90","subject":"ç»­è´¹","product_code":"QUICK_WAP_PAY"}
```

### æ­£ç¡®çš„URLï¼ˆæœ‰app_idå’Œç­¾åï¼‰âœ…
```
https://openapi.alipay.com/gateway.do?
  app_id=2021001234567890&
  method=alipay.trade.wap.pay&
  ... (å…¶ä»–å‚æ•°) ...
  sign=Kax1gkEHRt%2Be9uqp%2F0dxPvZR...  â† å…³é”®ï¼šRSA2ç­¾å
```

---

## ğŸ’¡ å…³é”®å‚æ•°è¯´æ˜

| å‚æ•° | å¿…éœ€ | è¯´æ˜ |
|------|------|------|
| app_id | âœ… | æ”¯ä»˜å®åˆ†é…çš„AppID |
| method | âœ… | æ¥å£åç§° |
| format | âœ… | JSON |
| charset | âœ… | utf-8 |
| sign_type | âœ… | RSA2 |
| timestamp | âœ… | yyyy-MM-dd HH:mm:ss |
| version | âœ… | 1.0 |
| biz_content | âœ… | ä¸šåŠ¡å‚æ•°ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰|
| sign | âœ… | RSA2ç­¾åï¼ˆç”Ÿäº§å¿…éœ€ï¼‰|
| notify_url | æ¨è | å¼‚æ­¥é€šçŸ¥åœ°å€ |
| return_url | æ¨è | åŒæ­¥è·³è½¬åœ°å€ |

---

## ğŸ” ç­¾åè¯´æ˜

### ä¸ºä»€ä¹ˆéœ€è¦ç­¾åï¼Ÿ
1. **é˜²ç¯¡æ”¹**ï¼šç¡®ä¿å‚æ•°æœªè¢«ä¿®æ”¹
2. **èº«ä»½éªŒè¯**ï¼šè¯æ˜è¯·æ±‚æ¥è‡ªåˆæ³•å•†æˆ·
3. **å®‰å…¨æ€§**ï¼šé˜²æ­¢æ¶æ„æ”»å‡»

### ç­¾åæµç¨‹
```
1. å¯¹æ‰€æœ‰å‚æ•°æŒ‰é”®åæ’åº
2. æ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼škey1=value1&key2=value2...
3. ä½¿ç”¨å•†æˆ·ç§é’¥è¿›è¡ŒRSA2ç­¾å
4. Base64ç¼–ç ç­¾åç»“æœ
5. URLç¼–ç åæ·»åŠ åˆ°å‚æ•°ä¸­
```

### ä½¿ç”¨SDKè‡ªåŠ¨ç­¾åï¼ˆæ¨èï¼‰
```javascript
const alipaySdk = new AlipaySdk({...});
const url = alipaySdk.generatePageUrl({...}); // SDKè‡ªåŠ¨ç­¾å
```

---

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### ä¸´æ—¶æ–¹æ¡ˆï¼ˆå½“å‰ï¼‰âœ…
- [x] ä¿®æ”¹ `generateAlipayUrl` å‡½æ•°
- [x] æ·»åŠ ç¯å¢ƒå˜é‡æ£€æŸ¥
- [x] æ·»åŠ æ‰€æœ‰å¿…éœ€å‚æ•°
- [x] è¿”å›æµ‹è¯•URLï¼ˆæœªé…ç½®æ—¶ï¼‰
- [ ] é‡æ–°éƒ¨ç½²

### å®Œæ•´æ–¹æ¡ˆï¼ˆæ¨èï¼‰â³
- [ ] ç”³è¯·æ”¯ä»˜å®åº”ç”¨
- [ ] ç”ŸæˆRSAå¯†é’¥å¯¹
- [ ] é…ç½®Netlifyç¯å¢ƒå˜é‡
- [ ] å®‰è£… `alipay-sdk`
- [ ] æ›´æ–°ä»£ç ä½¿ç”¨SDK
- [ ] å®ç°ç­¾åéªŒè¯
- [ ] æµ‹è¯•çœŸå®æ”¯ä»˜æµç¨‹

---

## âš ï¸ é‡è¦æç¤º

### å½“å‰çŠ¶æ€
- âœ… ä¿®å¤äº† "missing-app-id" é”™è¯¯
- âœ… å¯ä»¥ç”Ÿæˆå¹¶æ˜¾ç¤ºäºŒç»´ç 
- âš ï¸ **ä¸èƒ½çœŸå®æ”¯ä»˜**ï¼ˆç¼ºå°‘ç­¾åï¼‰
- âœ… é€‚åˆUIæµ‹è¯•å’Œæ¼”ç¤º

### çœŸå®æ”¯ä»˜éœ€è¦
1. ç”³è¯·æ”¯ä»˜å®åº”ç”¨ï¼ˆéœ€è¦è¥ä¸šæ‰§ç…§ï¼‰
2. é…ç½®å¯†é’¥å¯¹
3. ä½¿ç”¨SDKç”Ÿæˆå¸¦ç­¾åçš„URL
4. é€šè¿‡æ”¯ä»˜å®å®¡æ ¸

---

**ä¿®å¤æ—¥æœŸï¼š** 2024-10-19  
**ç‰ˆæœ¬ï¼š** v1.2.1  
**çŠ¶æ€ï¼š** âœ… ä¸´æ—¶ä¿®å¤å®Œæˆï¼ˆå¯ç”ŸæˆäºŒç»´ç ï¼‰  
**ä¸‹ä¸€æ­¥ï¼š** ç”³è¯·æ”¯ä»˜å®åº”ç”¨ä»¥å®ç°çœŸå®æ”¯ä»˜

