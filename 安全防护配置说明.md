# 🛡️ 后端安全防护配置说明

## 概述
本系统实现了全面的安全防护机制，防止恶意攻击和端口滥用，包括速率限制、IP 过滤、请求验证等功能。

## 🔒 安全功能特性

### 1. 速率限制 (Rate Limiting)
- **时间窗口**: 15分钟
- **最大请求数**: 每个IP 100次请求
- **突发限制**: 1分钟内最多10次请求
- **自动封禁**: 超过200次请求自动封禁1小时

### 2. IP 管理
- **自动封禁**: 检测到恶意行为自动封禁
- **手动管理**: 支持手动封禁/解封IP
- **可疑监控**: 实时监控可疑IP活动
- **白名单**: 支持可信IP白名单（可扩展）

### 3. 请求验证
- **User-Agent 过滤**: 阻止爬虫和自动化工具
- **内容长度限制**: 最大1MB请求体
- **必需头部检查**: 验证必要的请求头
- **方法限制**: 只允许GET、POST、OPTIONS

### 4. 安全头部
- **X-Frame-Options**: 防止点击劫持
- **X-Content-Type-Options**: 防止MIME类型嗅探
- **X-XSS-Protection**: XSS保护
- **Strict-Transport-Security**: 强制HTTPS
- **Referrer-Policy**: 控制引用信息

## 🚀 部署配置

### 1. 环境变量设置
在 Netlify 环境变量中配置：

```bash
# GitHub API Token
GITHUB_TOKEN=your_github_token_here

# 管理员密钥（用于安全面板访问）
ADMIN_SECRET_KEY=your_secure_admin_key_here
```

### 2. 安全配置参数
可以在 `security-middleware.js` 中调整以下参数：

```javascript
const SECURITY_CONFIG = {
    RATE_LIMIT: {
        WINDOW_MS: 15 * 60 * 1000,        // 时间窗口
        MAX_REQUESTS: 100,                 // 最大请求数
        BURST_LIMIT: 10,                   // 突发限制
        BURST_WINDOW_MS: 60 * 1000         // 突发窗口
    },
    IP_BLOCKING: {
        AUTO_BLOCK_THRESHOLD: 200,         // 自动封禁阈值
        BLOCK_DURATION_MS: 60 * 60 * 1000, // 封禁时长
        SUSPICIOUS_THRESHOLD: 50           // 可疑阈值
    }
};
```

## 📊 监控和管理

### 1. 安全监控面板
访问地址: `https://your-domain.com/security-dashboard.html?key=your_admin_key`

功能包括：
- ✅ 实时安全统计
- ✅ 被封禁IP管理
- ✅ 可疑IP监控
- ✅ 手动封禁/解封
- ✅ 自动刷新数据

### 2. API 端点
- **统计信息**: `GET /api/security-admin/stats`
- **被封禁IP**: `GET /api/security-admin/blocked-ips`
- **可疑IP**: `GET /api/security-admin/suspicious-ips`
- **封禁IP**: `POST /api/security-admin/block-ip`
- **解封IP**: `POST /api/security-admin/unblock-ip`

### 3. 日志记录
系统会自动记录以下安全事件：
- 🚨 IP封禁事件
- ⚠️ 可疑行为检测
- 🔒 速率限制触发
- 📝 正常请求记录

## 🛠️ 使用方法

### 1. 基本使用
系统会自动运行，无需额外配置。所有API请求都会经过安全检查。

### 2. 手动管理
```bash
# 封禁IP
curl -X POST https://your-domain.com/api/security-admin/block-ip \
  -H "X-Admin-Key: your_admin_key" \
  -H "Content-Type: application/json" \
  -d '{"ip": "192.168.1.100", "duration": 3600000}'

# 解封IP
curl -X POST https://your-domain.com/api/security-admin/unblock-ip \
  -H "X-Admin-Key: your_admin_key" \
  -H "Content-Type: application/json" \
  -d '{"ip": "192.168.1.100"}'

# 查看统计
curl -H "X-Admin-Key: your_admin_key" \
  https://your-domain.com/api/security-admin/stats
```

### 3. 监控面板使用
1. 访问监控面板URL
2. 输入管理员密钥
3. 查看实时安全状态
4. 管理被封禁的IP
5. 手动封禁可疑IP

## ⚠️ 注意事项

### 1. 安全建议
- 🔐 定期更换管理员密钥
- 📊 定期检查安全日志
- 🚨 关注异常流量模式
- 🔄 及时更新安全配置

### 2. 性能考虑
- 内存存储适用于中小型应用
- 大型应用建议使用Redis或数据库
- 定期清理过期的请求记录
- 监控内存使用情况

### 3. 扩展功能
- 可以添加IP白名单功能
- 可以集成第三方威胁情报
- 可以添加地理位置过滤
- 可以实现更复杂的攻击检测

## 🔧 故障排除

### 1. 常见问题
- **403错误**: 检查IP是否被封禁
- **429错误**: 请求频率过高，等待重试
- **401错误**: 管理员密钥不正确
- **500错误**: 服务器内部错误，检查日志

### 2. 调试方法
```bash
# 检查函数日志
netlify functions:log

# 本地测试
netlify dev

# 查看环境变量
netlify env:list
```

### 3. 联系支持
如果遇到问题，请：
1. 检查Netlify函数日志
2. 验证环境变量配置
3. 测试API端点响应
4. 查看浏览器控制台错误

## 📈 性能优化

### 1. 内存优化
- 定期清理过期数据
- 限制内存存储大小
- 使用LRU缓存策略

### 2. 网络优化
- 使用CDN加速
- 启用HTTP/2
- 压缩响应数据

### 3. 监控优化
- 设置性能告警
- 监控响应时间
- 跟踪错误率

---

**重要提醒**: 安全防护是一个持续的过程，请定期检查和更新安全策略，确保系统始终受到最佳保护。
