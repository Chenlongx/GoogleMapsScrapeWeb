# 推广链接追踪系统部署修复说明

## 问题描述
线上部署时出现错误：`Could not find the 'agent_code' column of 'orders' in the schema cache`

## 解决方案

### 步骤1：更新数据库结构

在 Supabase SQL 编辑器中执行以下脚本：

#### 1.1 创建临时推广追踪表
```sql
-- 执行 temp_referral_table.sql 中的内容
CREATE TABLE IF NOT EXISTS referral_tracking (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    out_trade_no VARCHAR(128) NOT NULL,
    referral_code VARCHAR(100),
    agent_code VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_referral_tracking_out_trade_no ON referral_tracking(out_trade_no);
CREATE INDEX IF NOT EXISTS idx_referral_tracking_referral_code ON referral_tracking(referral_code);
CREATE INDEX IF NOT EXISTS idx_referral_tracking_agent_code ON referral_tracking(agent_code);
```

#### 1.2 为 orders 表添加推广字段（可选，推荐）
```sql
-- 执行 database_migration.sql 中的内容
ALTER TABLE orders 
ADD COLUMN IF NOT EXISTS referral_code VARCHAR(100),
ADD COLUMN IF NOT EXISTS agent_code VARCHAR(50);

CREATE INDEX IF NOT EXISTS idx_orders_referral_code ON orders(referral_code);
CREATE INDEX IF NOT EXISTS idx_orders_agent_code ON orders(agent_code);
```

### 步骤2：部署代码更新

将以下修改后的文件部署到线上：

1. `netlify/functions/payment.js` - 修复了数据库字段兼容性问题
2. `netlify/functions/business-logic.js` - 修复了推广佣金处理逻辑
3. `assets/js/referral-tracker.js` - 新增的推广追踪器
4. `assets/js/main.js` - 添加了推广追踪器初始化
5. `checkout.html` - 修复了支付流程中的推广信息传递

### 步骤3：验证部署

1. **测试支付流程**：
   - 访问 https://mediamingle.cn/checkout.html
   - 尝试购买产品，确保支付流程正常

2. **测试推广链接**：
   - 使用代理推广链接访问官网
   - 确保推广信息在页面跳转中保持
   - 完成购买后检查代理端是否显示订单

3. **检查日志**：
   - 查看 Netlify Functions 日志
   - 确认没有数据库字段错误

## 兼容性说明

### 当前实现特点：
- **向后兼容**：代码会自动检测数据库是否支持推广字段
- **临时存储**：如果 orders 表没有推广字段，会使用 referral_tracking 表
- **优雅降级**：即使推广信息存储失败，也不会影响正常支付流程

### 数据库结构选择：

**方案A：使用临时表（当前实现）**
- 优点：不需要修改现有 orders 表结构
- 缺点：需要额外的表来存储推广信息

**方案B：更新 orders 表（推荐）**
- 优点：数据结构更清晰，查询更高效
- 缺点：需要修改现有表结构

## 故障排除

### 如果仍然出现数据库错误：
1. 检查 Supabase 连接配置
2. 确认环境变量正确设置
3. 验证数据库表是否创建成功

### 如果推广信息不显示：
1. 检查 referral_tracking 表是否有数据
2. 确认推广链接格式正确
3. 查看浏览器控制台是否有 JavaScript 错误

## 后续优化

1. **数据库迁移**：建议最终将推广字段直接添加到 orders 表
2. **性能优化**：添加适当的数据库索引
3. **监控告警**：添加推广佣金处理的监控和告警

## 联系支持

如果遇到问题，请提供：
1. 具体的错误信息
2. Netlify Functions 日志
3. 浏览器控制台错误
4. 数据库查询结果
