# 续费时长计算错误修复说明

## 🐛 问题描述

**现象：**
- ✅ 支付成功，账号确实续费了
- ❌ 但续费后的到期时间不对，续费弹窗显示的到期时间还是今天

**示例：**
```
原到期时间：2025-10-19（今天，已过期）
续费1个月后
预期到期时间：2025-11-19（今天 + 1个月）✅
实际到期时间：2025-10-19（没有延长）❌
```

---

## 🔍 问题根源

### 原因1：续费时长判断失败

`business-logic.js` 中的续费逻辑通过 `subjectText` 判断续费时长：

```javascript
// ❌ 旧代码
if (subjectText.includes('月度')) {
    newExpiryDate.setMonth(newExpiryDate.getMonth() + 1);
} else if (subjectText.includes('季度')) {
    newExpiryDate.setMonth(newExpiryDate.getMonth() + 3);
} else if (subjectText.includes('年度')) {
    newExpiryDate.setFullYear(newExpiryDate.getFullYear() + 1);
}
```

**问题：**
- 实际的 `subject` 是：`"谷歌地图商家爬虫-1个月续费"`（月付）
- 判断条件是：`月度`、`季度`、`年度`
- **结果：** 没有匹配到任何条件，`renewalMonths = 0`，到期时间没有延长！

### 原因2：依赖文本匹配不可靠

文本匹配存在以下问题：
1. **关键词不匹配**：`"1个月"` ≠ `"月度"`
2. **容易出错**：如果 subject 格式稍有变化就会失效
3. **难以维护**：需要记住所有可能的文本格式

---

## ✅ 修复方案

### 1. 优先使用 `product_id` 判断

`product_id` 是标准化的字段，更可靠：
- `gmaps_renewal_monthly` → 1个月
- `gmaps_renewal_quarterly` → 3个月
- `gmaps_renewal_yearly` → 12个月

### 2. 回退到增强的文本判断

如果 `product_id` 不存在，使用增强的文本匹配：
- 支持：`月度`、`月付`、`1个月`
- 支持：`季度`、`季付`、`3个月`
- 支持：`年度`、`年付`、`1年`

### 3. 添加默认兜底逻辑

如果都无法判断，默认为 1 个月。

---

## 📝 修改内容

### `business-logic.js` - 修复续费时长计算

```javascript
// 2. 计算新的到期时间
const currentExpiry = new Date(user.expiry_at);
const now = new Date();

console.log(`[Renewal] 当前到期时间: ${currentExpiry.toISOString()}`);
console.log(`[Renewal] 当前时间: ${now.toISOString()}`);

// 如果账户已过期，则从当前时间开始计算；否则从原到期时间延长
const startDate = currentExpiry < now ? now : currentExpiry;
console.log(`[Renewal] 续费起始时间: ${startDate.toISOString()}`);

const newExpiryDate = new Date(startDate);

// 🔒 【修复】优先使用 product_id 判断续费时长，更可靠
let renewalMonths = 0;
if (productId) {
    if (productId.includes('monthly')) {
        renewalMonths = 1;
    } else if (productId.includes('quarterly')) {
        renewalMonths = 3;
    } else if (productId.includes('yearly')) {
        renewalMonths = 12;
    }
    console.log(`[Renewal] 从 product_id (${productId}) 判断: ${renewalMonths} 个月`);
}

// 如果 product_id 没有匹配，回退到 subject 文本判断
if (renewalMonths === 0) {
    if (subjectText.includes('月度') || subjectText.includes('月付') || subjectText.includes('1个月')) {
        renewalMonths = 1;
    } else if (subjectText.includes('季度') || subjectText.includes('季付') || subjectText.includes('3个月')) {
        renewalMonths = 3;
    } else if (subjectText.includes('年度') || subjectText.includes('年付') || subjectText.includes('1年')) {
        renewalMonths = 12;
    }
    console.log(`[Renewal] 从 subject (${subjectText}) 判断: ${renewalMonths} 个月`);
}

// 如果还是没有匹配，默认为1个月
if (renewalMonths === 0) {
    console.warn(`[Renewal] 无法判断续费时长，默认为1个月`);
    renewalMonths = 1;
}

// 计算新的到期时间
newExpiryDate.setMonth(newExpiryDate.getMonth() + renewalMonths);
console.log(`[Renewal] 新的到期时间: ${newExpiryDate.toISOString()} (延长 ${renewalMonths} 个月)`);
```

---

## 📊 修复前后对比

### 修复前

**日志：**
```
[Renewal] Processing renewal for 1491367041@qq.com
[Renewal] 当前到期时间: 2025-10-19T10:53:00+00:00
[Renewal] 当前时间: 2025-10-19T14:00:00+00:00
[Renewal] 续费起始时间: 2025-10-19T14:00:00+00:00
（没有匹配到续费时长，renewalMonths = 0）
[Renewal] 新的到期时间: 2025-10-19T14:00:00+00:00  ❌ 没有延长
```

**结果：**
- 原到期：2025-10-19
- 新到期：2025-10-19 ❌（没有变化）

### 修复后

**日志：**
```
[Renewal] Processing renewal for 1491367041@qq.com
[Renewal] 当前到期时间: 2025-10-19T10:53:00+00:00
[Renewal] 当前时间: 2025-10-19T14:00:00+00:00
[Renewal] 续费起始时间: 2025-10-19T14:00:00+00:00
[Renewal] 从 product_id (gmaps_renewal_monthly) 判断: 1 个月 ✅
[Renewal] 新的到期时间: 2025-11-19T14:00:00+00:00 (延长 1 个月) ✅
```

**结果：**
- 原到期：2025-10-19
- 新到期：2025-11-19 ✅（延长了1个月）

---

## 🧪 测试场景

### 场景1：账号已过期

```
当前时间：2025-10-19 14:00
原到期时间：2025-10-19 10:53（今天早上，已过期）
续费1个月

预期结果：
起始时间：2025-10-19 14:00（当前时间）
新到期时间：2025-11-19 14:00 ✅
```

### 场景2：账号未过期

```
当前时间：2025-10-19 14:00
原到期时间：2025-11-10 10:53（还有21天到期）
续费1个月

预期结果：
起始时间：2025-11-10 10:53（原到期时间）
新到期时间：2025-12-10 10:53 ✅（在原基础上延长）
```

### 场景3：续费3个月（季付）

```
当前时间：2025-10-19 14:00
原到期时间：2025-10-19 10:53（已过期）
续费3个月

预期结果：
起始时间：2025-10-19 14:00
新到期时间：2026-01-19 14:00 ✅
```

### 场景4：续费12个月（年付）

```
当前时间：2025-10-19 14:00
原到期时间：2025-10-19 10:53（已过期）
续费12个月

预期结果：
起始时间：2025-10-19 14:00
新到期时间：2026-10-19 14:00 ✅
```

---

## 🚀 部署步骤

### 1. 提交修改

```bash
cd D:\GoogleMapsScrapeWeb
git add netlify/functions/business-logic.js
git commit -m "fix: 修复续费时长计算错误，优先使用 product_id 判断"
git push origin main
```

### 2. 等待部署

- 登录 [Netlify 控制台](https://app.netlify.com)
- 等待部署完成（约 1-3 分钟）

### 3. 测试续费

1. 打开 QT 应用 → 续费
2. 选择月付 ¥29.90
3. 生成二维码并支付
4. 等待支付成功提示

### 4. 查看 Netlify 日志

```bash
netlify functions:log business-logic
```

**应该看到：**
```
[Renewal] Processing renewal for 1491367041@qq.com
[Renewal] 当前到期时间: 2025-10-19T10:53:00+00:00
[Renewal] 当前时间: 2025-10-19T14:XX:XX+00:00
[Renewal] 续费起始时间: 2025-10-19T14:XX:XX+00:00
[Renewal] 从 product_id (gmaps_renewal_monthly) 判断: 1 个月
[Renewal] 新的到期时间: 2025-11-19T14:XX:XX+00:00 (延长 1 个月)
✅ Renewal successful for 1491367041@qq.com
```

### 5. 验证结果

**QT 支付成功对话框：**
```
🎉 支付成功！

续费类型: 月付
新到期时间: 2025-11-19  ✅（比今天晚1个月）

感谢您的支持！
```

**QT 主界面：**
```
授权剩余: 31 天  ✅
```

**Supabase 数据库：**
```sql
SELECT account, expiry_at FROM user_accounts WHERE account = '1491367041@qq.com';

结果：
account: 1491367041@qq.com
expiry_at: 2025-11-19T14:XX:XX+00:00  ✅
```

---

## 🔍 验证方法

### 方法1：对比续费前后的到期时间

**续费前：**
```
授权状态: 已过期
或
授权剩余: X 天
```

**续费后（月付）：**
```
授权剩余: 31 天 ✅（大约1个月）
```

**续费后（季付）：**
```
授权剩余: 92 天 ✅（大约3个月）
```

**续费后（年付）：**
```
授权剩余: 365 天 ✅（大约1年）
```

### 方法2：查看 Netlify 日志

```bash
netlify functions:log business-logic
```

搜索关键词：`[Renewal]`

确认日志中显示：
- ✅ `从 product_id (gmaps_renewal_monthly) 判断: 1 个月`
- ✅ `新的到期时间: 2025-11-19... (延长 1 个月)`

### 方法3：数据库验证

登录 Supabase 控制台，查询 `user_accounts` 表：

```sql
SELECT 
  account, 
  expiry_at, 
  DATE_PART('day', expiry_at - NOW()) AS remaining_days
FROM user_accounts 
WHERE account = '1491367041@qq.com';
```

确认 `remaining_days` ≈ 31（月付）、92（季付）或 365（年付）。

---

## 💡 技术要点

### 续费时长判断优先级

1. **优先：** `product_id`（最可靠）
   ```javascript
   if (productId.includes('monthly')) renewalMonths = 1;
   ```

2. **次选：** `subject` 文本匹配（兼容旧数据）
   ```javascript
   if (subjectText.includes('月付') || subjectText.includes('1个月')) renewalMonths = 1;
   ```

3. **兜底：** 默认1个月
   ```javascript
   if (renewalMonths === 0) renewalMonths = 1;
   ```

### 续费起始时间计算

```javascript
const currentExpiry = new Date(user.expiry_at);
const now = new Date();

// 如果账户已过期，从今天开始算
// 如果账户未过期，从原到期时间开始算
const startDate = currentExpiry < now ? now : currentExpiry;
```

**示例：**
- **已过期账号：** 原到期 2025-10-15，今天 2025-10-19
  - `startDate = 2025-10-19`（今天）
  - 续费1个月后：2025-11-19

- **未过期账号：** 原到期 2025-11-15，今天 2025-10-19
  - `startDate = 2025-11-15`（原到期时间）
  - 续费1个月后：2025-12-15

---

## ❓ 常见问题

### Q1: 为什么使用 `setMonth()` 而不是简单的 `+ 30 天`？
A: `setMonth()` 会自动处理不同月份的天数差异：
- 1月31日 + 1个月 = 2月28/29日（自动调整）
- 简单的 `+ 30天` 可能导致日期不准确

### Q2: 如果 `product_id` 和 `subject` 都匹配失败怎么办？
A: 会使用默认值 1 个月，并记录警告日志。这是一个兜底机制，确保至少会延长一些时间。

### Q3: 续费后立即显示新的到期时间吗？
A: 是的。`checkPaymentStatus` 会在支付成功后立即查询数据库中的新 `expiry_at`，并返回给前端。

---

## 📝 相关文件

| 文件 | 修改内容 |
|------|---------|
| `netlify/functions/business-logic.js` | 修复续费时长判断逻辑，优先使用 `product_id` |
| `续费时长计算错误修复说明.md` | 本文档 |

---

**最后更新：** 2025-10-19  
**版本：** v1.0  
**状态：** ✅ 已修复，待部署测试

