# 主动查询支付状态修复说明

## 🐛 问题描述

**现象：**
- ✅ 二维码可以正常扫描和支付
- ✅ 支付宝显示支付成功
- ❌ QT 应用检测不到支付成功（一直显示"等待支付"）
- ❌ 订单状态一直是 `PENDING`，未更新为 `COMPLETED`

**日志显示：**
```
checkPaymentStatus 日志:
🔍 查询订单状态: orderId=grm-xxx
✅ 找到订单: status=PENDING, product_id=gmaps_renewal_monthly
（一直是 PENDING 状态，没有变化）
```

---

## 🔍 问题根源

### 支付宝回调机制的限制

**扫码支付（precreate）的回调特点：**
1. 在**生产环境**下，支付成功后支付宝会主动回调 `notify_url`
2. 在**沙箱/测试环境**下，回调可能不会被触发
3. 即使在生产环境，回调也可能因为网络问题延迟或失败

**当前流程的问题：**
```
用户支付成功
  ↓
等待支付宝回调 alipay-notify ⏳
  ↓
（回调可能没有触发）
  ↓
QT 应用轮询 checkPaymentStatus
  ↓
发现订单还是 PENDING ❌
  ↓
返回"等待支付" ❌
```

### 为什么回调可能失败？

1. **测试环境限制**：支付宝沙箱环境的回调不稳定
2. **网络问题**：Netlify 服务器可能暂时无法访问
3. **签名验证失败**：密钥配置问题导致回调被拒绝
4. **超时**：支付宝回调有超时限制，超时后不再重试

---

## ✅ 修复方案：主动查询模式

### 核心思路

不依赖支付宝的被动回调，而是在 `checkPaymentStatus` 中**主动调用支付宝 API 查询订单状态**。

### 修复后的流程

```
用户支付成功
  ↓
QT 应用轮询 checkPaymentStatus（每 2 秒）
  ↓
checkPaymentStatus 发现订单是 PENDING
  ↓
🔑 主动调用支付宝 API 查询订单状态 ✅
  ↓
支付宝返回: tradeStatus = "TRADE_SUCCESS"
  ↓
更新订单状态为 COMPLETED
  ↓
调用 business-logic.js 处理续费
  ↓
更新 user_accounts 表的 expiry_at
  ↓
返回支付成功 + 新到期时间
  ↓
QT 应用显示"🎉 支付成功！" ✅
```

---

## 📝 修改内容

### `checkPaymentStatus.js` - 添加主动查询逻辑

```javascript
// ✅ 新增：引入支付宝SDK和业务逻辑
const AlipaySdk = require('alipay-sdk').default || require('alipay-sdk');
const { processBusinessLogic } = require('./business-logic.js');

// ✅ 新增：格式化密钥函数
function formatKey(key, type) { ... }

// ✅ 新增：主动查询支付宝订单状态
if (orderData.status === 'PENDING') {
  console.log(`🔍 订单状态为 PENDING，主动查询支付宝订单状态...`);
  
  // 1. 初始化支付宝SDK
  const alipaySdk = new AlipaySdk({ ... });
  
  // 2. 调用 alipay.trade.query 查询订单
  const queryResult = await alipaySdk.exec('alipay.trade.query', {
    bizContent: { out_trade_no: orderId }
  });
  
  // 3. 检查支付状态
  if (queryResult.tradeStatus === 'TRADE_SUCCESS') {
    // 4. 更新订单状态为 COMPLETED
    await supabase.from('orders')
      .update({ status: 'COMPLETED' })
      .eq('out_trade_no', orderId);
    
    // 5. 调用 business-logic.js 处理续费
    const mockParams = new URLSearchParams();
    mockParams.append('out_trade_no', orderId);
    mockParams.append('trade_status', 'TRADE_SUCCESS');
    await processBusinessLogic(mockParams);
    
    // 6. 查询新的到期时间并返回
    const userData = await supabase.from('user_accounts')
      .select('expiry_at')
      .eq('account', orderData.customer_email)
      .single();
    
    return {
      success: true,
      paid: true,
      newExpiryDate: userData.expiry_at
    };
  }
}
```

### `alipay-notify.js` - 添加详细日志

```javascript
exports.handler = async (event) => {
  console.log('🔔 [alipay-notify] 收到支付宝回调');
  console.log('📦 [alipay-notify] 回调参数:', JSON.stringify(paramsJSON, null, 2));
  console.log('🔐 [alipay-notify] 开始验证签名...');
  console.log('✅ [alipay-notify] 签名验证成功！');
  console.log(`📊 [alipay-notify] 订单状态: ${tradeStatus}, 订单号: ${outTradeNo}`);
  // ...
};
```

---

## 📊 修复前后对比

### 修复前：被动等待回调

| 步骤 | 操作 | 结果 |
|------|------|------|
| 1 | 用户支付成功 | ✅ |
| 2 | 支付宝尝试回调 `alipay-notify` | ❌ 可能失败 |
| 3 | `checkPaymentStatus` 查询订单状态 | `PENDING` |
| 4 | 返回"等待支付" | ❌ 一直等待 |
| 5 | 超时（5分钟后） | ❌ 支付失败 |

**成功率：** 取决于回调是否成功（可能 < 50%）

### 修复后：主动查询状态

| 步骤 | 操作 | 结果 |
|------|------|------|
| 1 | 用户支付成功 | ✅ |
| 2 | `checkPaymentStatus` 查询订单状态 | `PENDING` |
| 3 | **主动调用支付宝 API 查询订单** | `TRADE_SUCCESS` ✅ |
| 4 | 更新订单状态 → 处理续费 | ✅ |
| 5 | 返回"支付成功" + 新到期时间 | ✅ |

**成功率：** 接近 100%（只要支付宝 API 可用）

---

## 🚀 部署步骤

### 1. 提交修改

```bash
cd D:\GoogleMapsScrapeWeb
git add netlify/functions/checkPaymentStatus.js
git add netlify/functions/alipay-notify.js
git commit -m "fix: 添加主动查询支付状态，解决回调失败问题"
git push origin main
```

### 2. 等待部署

- 登录 [Netlify 控制台](https://app.netlify.com)
- 等待部署完成（约 1-3 分钟）
- 查看部署日志确认成功

### 3. 测试续费流程

#### 步骤 1：生成二维码并支付

1. 打开 QT 应用 → 续费
2. 选择月付 ¥29.90
3. 点击"生成支付二维码"
4. 用支付宝扫码并完成支付

#### 步骤 2：观察 QT 控制台

**修复前：**
```
⏳ 正在检查支付状态...
⏳ 正在检查支付状态...
⏳ 正在检查支付状态...
（一直循环，直到超时）
```

**修复后：**
```
⏳ 正在检查支付状态...
⏳ 正在检查支付状态...
✅ 检测到支付成功！
🎉 支付成功！

续费类型: 月付
新到期时间: 2025-11-19

感谢您的支持！
```

#### 步骤 3：查看 Netlify 日志

```bash
netlify functions:log checkPaymentStatus
```

**应该看到：**
```
🔍 查询订单状态: orderId=grm-xxx
✅ 找到订单: status=PENDING, product_id=gmaps_renewal_monthly
🔍 订单状态为 PENDING，主动查询支付宝订单状态...
📊 支付宝订单查询结果: {"tradeStatus":"TRADE_SUCCESS",...}
✅ 支付宝确认订单已支付，开始更新订单状态...
✅ 订单状态已更新为 COMPLETED
🔧 开始调用 business-logic.js 处理续费...
✅ business-logic.js 处理完成
✅ 续费成功！renewalType=monthly, newExpiry=2025-11-19T10:53:00+00:00
```

---

## 🔍 验证方法

### 方法 1：查看数据库

登录 Supabase 控制台：

**`orders` 表：**
```sql
SELECT * FROM orders WHERE out_trade_no LIKE 'grm-%' ORDER BY created_at DESC LIMIT 1;
```
应该看到：
- `status` = `COMPLETED` ✅
- `product_id` = `gmaps_renewal_monthly`

**`user_accounts` 表：**
```sql
SELECT account, expiry_at FROM user_accounts WHERE account = '1491367041@qq.com';
```
应该看到：
- `expiry_at` 已更新为新的到期时间 ✅

### 方法 2：查看 QT 主界面

**修复前：**
```
授权状态: 已过期
```

**修复后：**
```
授权剩余: 31 天
```

---

## 💡 技术要点

### 支付宝订单查询 API

```javascript
const queryResult = await alipaySdk.exec('alipay.trade.query', {
  bizContent: {
    out_trade_no: orderId  // 商户订单号
  }
});

// 返回结果
{
  "code": "10000",
  "msg": "Success",
  "tradeNo": "2024101922001...",  // 支付宝交易号
  "outTradeNo": "grm-xxx",        // 商户订单号
  "tradeStatus": "TRADE_SUCCESS", // 交易状态
  "totalAmount": "29.90",         // 订单金额
  ...
}
```

### 交易状态说明

| 状态 | 说明 | 处理方式 |
|------|------|---------|
| `WAIT_BUYER_PAY` | 等待买家付款 | 返回"等待支付" |
| `TRADE_CLOSED` | 交易关闭（超时未支付） | 返回"支付失败" |
| `TRADE_SUCCESS` | 支付成功 | 更新订单 + 处理续费 ✅ |
| `TRADE_FINISHED` | 交易完结（不可退款） | 更新订单 + 处理续费 ✅ |

### 双重保障机制

```
主动查询（checkPaymentStatus）
  ↓
支付成功 → 更新订单 → 处理续费
  ↑
被动回调（alipay-notify，可选）
```

两种方式互为补充，确保支付成功后一定能续费。

---

## ❓ 常见问题

### Q1: 为什么不直接禁用回调，只用主动查询？
A: 回调可以实时处理，主动查询需要等待轮询。两者结合可以达到最佳效果：回调优先处理，查询兜底保障。

### Q2: 主动查询会不会增加支付宝 API 调用量？
A: 会有一定增加，但由于轮询间隔是 2 秒，最多查询 150 次（5 分钟），在可接受范围内。

### Q3: 如果支付宝 API 查询也失败怎么办？
A: 代码中有 try-catch 保护，查询失败不会影响正常流程。用户可以稍后重新打开续费对话框，或者等待回调处理。

### Q4: 这次修复会影响网页版吗？
A: 不会。网页版使用 `check-status.js`，与 QT 应用的 `checkPaymentStatus.js` 是不同的函数。

---

## 📝 相关文件

| 文件 | 修改内容 |
|------|---------|
| `netlify/functions/checkPaymentStatus.js` | 添加主动查询支付宝订单状态的逻辑 |
| `netlify/functions/alipay-notify.js` | 添加详细的调试日志 |
| `主动查询支付状态修复说明.md` | 本文档 |

---

**最后更新：** 2025-10-19  
**版本：** v4.0  
**状态：** ✅ 已修复，待部署测试

